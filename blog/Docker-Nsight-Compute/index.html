<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="twitter:image:src" content="https://leimao.github.io/images/favicon/android-chrome-512x512.png"><meta name="referrer" content="no-referrer-when-downgrade"><title>Nsight Compute In Docker - Lei Mao&#039;s Log Book</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="Lei Mao&#039;s Log Book"><meta name="msapplication-TileImage" content="/images/favicon/android-chrome-192x192.png"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Lei Mao&#039;s Log Book"><meta name="apple-mobile-web-app-status-bar-style" content="default"><link rel="apple-touch-icon" sizes="192x192" href="/images/favicon/android-chrome-192x192.png"><link rel="apple-touch-icon" sizes="512x512" href="/images/favicon/android-chrome-512x512.png"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="16x16" href="/images/favicon/favicon-16x16.png"><link rel="apple-touch-icon" sizes="32x32" href="/images/favicon/favicon-32x32.png"><meta name="description" content="Portable Nsight Compute"><meta property="og:type" content="blog"><meta property="og:title" content="Nsight Compute In Docker"><meta property="og:url" content="https://leimao.github.io/blog/Docker-Nsight-Compute/"><meta property="og:site_name" content="Lei Mao&#039;s Log Book"><meta property="og:description" content="Portable Nsight Compute"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://leimao.github.io/images/blog/2024-01-02-Docker-Nsight-Compute/gemm_native.png"><meta property="article:published_time" content="2024-01-02T08:00:00.000Z"><meta property="article:modified_time" content="2024-01-02T08:00:00.000Z"><meta property="article:author" content="Lei Mao"><meta property="article:tag" content="CUDA"><meta property="article:tag" content="NVIDIA"><meta property="article:tag" content="Docker"><meta property="article:tag" content="Nsight Compute"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://leimao.github.io/images/blog/2024-01-02-Docker-Nsight-Compute/gemm_native.png"><meta property="twitter:creator" content="@matchaleimao"><meta property="twitter:site" content="Lei Mao&#039;s Log Book"><meta property="fb:admins" content="dukeleimao"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://leimao.github.io/blog/Docker-Nsight-Compute/"},"headline":"Nsight Compute In Docker","image":["https://leimao.github.io/images/blog/2024-01-02-Docker-Nsight-Compute/gemm_native.png"],"datePublished":"2024-01-02T08:00:00.000Z","dateModified":"2024-01-02T08:00:00.000Z","author":{"@type":"Person","name":"Lei Mao"},"publisher":{"@type":"Organization","name":"Lei Mao's Log Book","logo":{"@type":"ImageObject","url":"https://leimao.github.io/images/favicon/android-chrome-512x512.png"}},"description":"Portable Nsight Compute"}</script><link rel="canonical" href="https://leimao.github.io/blog/Docker-Nsight-Compute/"><link rel="alternate" href="/atom.xml" title="Lei Mao&#039;s Log Book" type="application/atom+xml"><link rel="icon" href="/images/favicon/favicon.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons/css/academicons.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=PT+Sans+Narrow:wght@400;700&amp;family=PT+Serif"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-EJY6FXZBCB" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-EJY6FXZBCB');</script><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><script src="//m.servedby-buysellads.com/monetization.custom.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/favicon/android-chrome-512x512.png" alt="Lei Mao&#039;s Log Book" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Lei Mao&#039;s Log Book</a><a class="navbar-item" href="/curriculum">Curriculum</a><a class="navbar-item" href="/blog">Blog</a><a class="navbar-item" href="/article">Articles</a><a class="navbar-item" href="/project">Projects</a><a class="navbar-item" href="/publication">Publications</a><a class="navbar-item" href="/reading">Readings</a><a class="navbar-item" href="/life">Life</a><a class="navbar-item" href="/essay">Essay</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/faq">FAQs</a></div><div class="navbar-end"><a class="navbar-item night" id="night-nav" title="Switch Color Scheme" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/leimao"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Gitter" href="https://gitter.im/leimao/community"><i class="fab fa-gitter"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><div class="card-content"><center><div class="bsa-standard" id="carbon-ad-01"></div><script>            (function() {             if (typeof _bsa !== 'undefined' && _bsa) {                 _bsa.init('custom', 'CWYD65QY', 'placement:leimaogithubio-standard', {                     target: '#carbon-ad-01',                     template: `             <a href='##link##' class='native-banner' style='background: ##backgroundColor##' rel='sponsored noopener' target='_blank' title='##company## — ##tagline##'>                 <img class='native-img' width='125' src='##logo##' />                 <div class='native-main'>                     <div class='native-details' style='                             color: ##textColor##;                             border-left: solid 1px ##textColor##;                         '>                         <span class='native-company'>Sponsored by ##company##</span>                         <span class='native-desc'>##description##</span>                     </div>                     <span class='native-cta' style='                             color: ##ctaTextColor##;                             background-color: ##ctaBackgroundColor##;                         '>##callToAction##</span>                 </div>             </a>             `,                 });                 }             })();         </script></center></div></div><div class="card"><article class="card-content article" role="article"><h1 class="title is-size-3" style="font-family: 'PT Sans Narrow', sans-serif">Nsight Compute In Docker</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left" style="margin-bottom: 0.50rem"><span class="level-item"><i class="far fa-calendar-alt"> </i><time dateTime="2024-01-02T08:00:00.000Z" title="2024-01-02T08:00:00.000Z">01-02-2024</time></span><span class="level-item is-hidden-mobile"><i class="far fa-calendar-check"> </i><time dateTime="2024-01-02T08:00:00.000Z" title="2024-01-02T08:00:00.000Z">01-02-2024</time></span><span class="level-item"><i class="far fa-folder-open has-text-grey"></i> <a class="link-muted" href="/blog/">blog</a></span><span class="level-item"><i class="far fa-clock"></i> 13 minutes read (About 1997 words)</span><span class="level-item" id="busuanzi_container_page_pv"><i class="far fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>&nbsp;visits</span></div></div><div class="content" style="margin-top: 1.0rem"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>NVIDIA Nsight Compute is an interactive profiler for CUDA that provides detailed performance metrics and API debugging via a user interface and command-line tool. Users can run guided analysis and compare results with a customizable and data-driven user interface, as well as post-process and analyze results in their own workflows.</p>
<p>In this blog post, I would like to discuss how to install and use Nsight Compute in Docker container so that we could use it and its GUI anywhere that has Docker installed.</p>
<h2 id="Nsight-Compute"><a href="#Nsight-Compute" class="headerlink" title="Nsight Compute"></a>Nsight Compute</h2><h3 id="Build-Docker-Image"><a href="#Build-Docker-Image" class="headerlink" title="Build Docker Image"></a>Build Docker Image</h3><p>It is possible to install Nsight Compute inside a Docker image and used it anywhere. The Dockerfile for building Nsight Compute is as follows.</p>
<figure class="highlight dockerfile"><figcaption><span>nsight-compute.Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nvcr.io/nvidia/cuda:<span class="number">12.0</span>.<span class="number">1</span>-devel-ubuntu22.<span class="number">04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> DEBIAN_FRONTEND noninteractive</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update -y &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y --no-install-recommends \</span></span><br><span class="line"><span class="language-bash">        apt-transport-https \</span></span><br><span class="line"><span class="language-bash">        ca-certificates \</span></span><br><span class="line"><span class="language-bash">        dbus \</span></span><br><span class="line"><span class="language-bash">        fontconfig \</span></span><br><span class="line"><span class="language-bash">        gnupg \</span></span><br><span class="line"><span class="language-bash">        libasound2 \</span></span><br><span class="line"><span class="language-bash">        libfreetype6 \</span></span><br><span class="line"><span class="language-bash">        libglib2.0-0 \</span></span><br><span class="line"><span class="language-bash">        libnss3 \</span></span><br><span class="line"><span class="language-bash">        libsqlite3-0 \</span></span><br><span class="line"><span class="language-bash">        libx11-xcb1 \</span></span><br><span class="line"><span class="language-bash">        libxcb-glx0 \</span></span><br><span class="line"><span class="language-bash">        libxcb-xkb1 \</span></span><br><span class="line"><span class="language-bash">        libxcomposite1 \</span></span><br><span class="line"><span class="language-bash">        libxcursor1 \</span></span><br><span class="line"><span class="language-bash">        libxdamage1 \</span></span><br><span class="line"><span class="language-bash">        libxi6 \</span></span><br><span class="line"><span class="language-bash">        libxml2 \</span></span><br><span class="line"><span class="language-bash">        libxrandr2 \</span></span><br><span class="line"><span class="language-bash">        libxrender1 \</span></span><br><span class="line"><span class="language-bash">        libxtst6 \</span></span><br><span class="line"><span class="language-bash">        libgl1-mesa-glx \</span></span><br><span class="line"><span class="language-bash">        libxkbfile-dev \</span></span><br><span class="line"><span class="language-bash">        openssh-client \</span></span><br><span class="line"><span class="language-bash">        wget \</span></span><br><span class="line"><span class="language-bash">        xcb \</span></span><br><span class="line"><span class="language-bash">        xkb-data &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get clean</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># QT6 is required for the Nsight Compute UI.</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update -y &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y --no-install-recommends \</span></span><br><span class="line"><span class="language-bash">        qt6-base-dev &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get clean</span></span><br></pre></td></tr></table></figure>

<p>To build the Docker image, please run the following command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -f nsight-compute.Dockerfile --no-cache --tag=nsight-compute:12.0.1 .</span><br></pre></td></tr></table></figure>

<h3 id="Upload-Docker-Image"><a href="#Upload-Docker-Image" class="headerlink" title="Upload Docker Image"></a>Upload Docker Image</h3><p>To build the Docker image, please run the following command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker tag nsight-compute:12.0.1 leimao/nsight-compute:12.0.1</span><br><span class="line">$ docker push leimao/nsight-compute:12.0.1</span><br></pre></td></tr></table></figure>

<h3 id="Pull-Docker-Image"><a href="#Pull-Docker-Image" class="headerlink" title="Pull Docker Image"></a>Pull Docker Image</h3><p>To pull the Docker image, please run the following command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull leimao/nsight-compute:12.0.1</span><br><span class="line">$ docker tag leimao/nsight-compute:12.0.1 nsight-compute:12.0.1</span><br></pre></td></tr></table></figure>

<h3 id="Run-Docker-Container"><a href="#Run-Docker-Container" class="headerlink" title="Run Docker Container"></a>Run Docker Container</h3><p>To run the Docker container, please run the following command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ xhost +</span><br><span class="line">$ docker run -it --<span class="built_in">rm</span> --gpus all -e DISPLAY=<span class="variable">$DISPLAY</span> -v /tmp/.X11-unix:/tmp/.X11-unix --cap-add=SYS_ADMIN --security-opt seccomp=unconfined -v $(<span class="built_in">pwd</span>):/mnt --network=host nsight-compute:12.0.1</span><br><span class="line">$ xhost -</span><br></pre></td></tr></table></figure>

<h3 id="Run-Nsight-Compute"><a href="#Run-Nsight-Compute" class="headerlink" title="Run Nsight Compute"></a>Run Nsight Compute</h3><p>To run Nsight Compute with GUI, please run the following command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ncu-ui</span><br></pre></td></tr></table></figure>

<p>We could now profile the applications from the Docker container, from the Docker local host machine via Docker mount, and from the remote host such as a remote workstation or an embedding device.</p>
<h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><h3 id="Non-Coalesced-Memory-Access-VS-Coalesced-Memory-Access"><a href="#Non-Coalesced-Memory-Access-VS-Coalesced-Memory-Access" class="headerlink" title="Non-Coalesced Memory Access VS Coalesced Memory Access"></a>Non-Coalesced Memory Access VS Coalesced Memory Access</h3><p>In this example, we implemented a naive GEMM kernel that performs matrix multiplication on the GPU. The kernel is naive because it did not use any advanced techniques such as shared memory tiling. Our original goal was to read and write the global memory in a coalesced manner. However, in the first version of the kernel, <code>gemm_non_coalesced</code>, we created a bug which swapped the row and column indices of the output matrix. Therefore, the kernel read and write the global memory in a non-coalesced manner. In the second version of the kernel, <code>gemm_coalesced</code>, we fixed the bug and read and write the global memory in a coalesced manner. We profiled the two kernels using Nsight Compute and compared the performance difference between the two kernels.</p>
<figure class="highlight c++"><figcaption><span>gemm_naive.cu</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cuda_runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHECK_CUDA_ERROR(val) check_cuda((val), #val, __FILE__, __LINE__)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">check_cuda</span><span class="params">(cudaError_t err, <span class="type">const</span> <span class="type">char</span>* <span class="type">const</span> func, <span class="type">const</span> <span class="type">char</span>* <span class="type">const</span> file,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">const</span> <span class="type">int</span> line)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err != cudaSuccess)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;CUDA Runtime Error at: &quot;</span> &lt;&lt; file &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; line</span><br><span class="line">                  &lt;&lt; std::endl;</span><br><span class="line">        std::cerr &lt;&lt; <span class="built_in">cudaGetErrorString</span>(err) &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; func &lt;&lt; std::endl;</span><br><span class="line">        std::<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHECK_LAST_CUDA_ERROR() check_cuda_last(__FILE__, __LINE__)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">check_cuda_last</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* <span class="type">const</span> file, <span class="type">const</span> <span class="type">int</span> line)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cudaError_t <span class="type">const</span> err&#123;<span class="built_in">cudaGetLastError</span>()&#125;;</span><br><span class="line">    <span class="keyword">if</span> (err != cudaSuccess)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;CUDA Runtime Error at: &quot;</span> &lt;&lt; file &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; line</span><br><span class="line">                  &lt;&lt; std::endl;</span><br><span class="line">        std::cerr &lt;&lt; <span class="built_in">cudaGetErrorString</span>(err) &lt;&lt; std::endl;</span><br><span class="line">        std::<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Non-coalesced read and write from global memory.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">gemm_non_coalesced</span><span class="params">(<span class="type">size_t</span> m, <span class="type">size_t</span> n, <span class="type">size_t</span> k, T alpha,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   T <span class="type">const</span>* A, <span class="type">size_t</span> lda, T <span class="type">const</span>* B,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">size_t</span> ldb, T beta, T* C, <span class="type">size_t</span> ldc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Compute the row and column of C that this thread is responsible for.</span></span><br><span class="line">    <span class="type">size_t</span> <span class="type">const</span> C_row_idx&#123;blockIdx.x * blockDim.x + threadIdx.x&#125;;</span><br><span class="line">    <span class="type">size_t</span> <span class="type">const</span> C_col_idx&#123;blockIdx.y * blockDim.y + threadIdx.y&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Each thread compute</span></span><br><span class="line">    <span class="comment">// C[C_row_idx, C_col_idx] = alpha * A[C_row_idx, :] * B[:, C_col_idx] +</span></span><br><span class="line">    <span class="comment">// beta * C[C_row_idx, C_col_idx].</span></span><br><span class="line">    <span class="keyword">if</span> (C_row_idx &lt; m &amp;&amp; C_col_idx &lt; n)</span><br><span class="line">    &#123;</span><br><span class="line">        T sum&#123;<span class="built_in">static_cast</span>&lt;T&gt;(<span class="number">0</span>)&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> k_idx&#123;<span class="number">0U</span>&#125;; k_idx &lt; k; ++k_idx)</span><br><span class="line">        &#123;</span><br><span class="line">            sum += A[C_row_idx * lda + k_idx] * B[k_idx * ldb + C_col_idx];</span><br><span class="line">        &#125;</span><br><span class="line">        C[C_row_idx * ldc + C_col_idx] =</span><br><span class="line">            alpha * sum + beta * C[C_row_idx * ldc + C_col_idx];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">launch_gemm_kernel_non_coalesced</span><span class="params">(<span class="type">size_t</span> m, <span class="type">size_t</span> n, <span class="type">size_t</span> k,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      T <span class="type">const</span>* alpha, T <span class="type">const</span>* A, <span class="type">size_t</span> lda,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      T <span class="type">const</span>* B, <span class="type">size_t</span> ldb, T <span class="type">const</span>* beta,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      T* C, <span class="type">size_t</span> ldc, cudaStream_t stream)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    dim3 <span class="type">const</span> block_dim&#123;<span class="number">32U</span>, <span class="number">8U</span>, <span class="number">1U</span>&#125;;</span><br><span class="line">    dim3 <span class="type">const</span> grid_dim&#123;</span><br><span class="line">        (<span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span> <span class="type">int</span>&gt;(m) + block_dim.x - <span class="number">1U</span>) / block_dim.x,</span><br><span class="line">        (<span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span> <span class="type">int</span>&gt;(n) + block_dim.y - <span class="number">1U</span>) / block_dim.y, <span class="number">1U</span>&#125;;</span><br><span class="line">    gemm_non_coalesced&lt;T&gt;&lt;&lt;&lt;grid_dim, block_dim, <span class="number">0U</span>, stream&gt;&gt;&gt;(</span><br><span class="line">        m, n, k, *alpha, A, lda, B, ldb, *beta, C, ldc);</span><br><span class="line">    <span class="built_in">CHECK_LAST_CUDA_ERROR</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Coalesced read and write from global memory.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">gemm_coalesced</span><span class="params">(<span class="type">size_t</span> m, <span class="type">size_t</span> n, <span class="type">size_t</span> k, T alpha,</span></span></span><br><span class="line"><span class="params"><span class="function">                               T <span class="type">const</span>* A, <span class="type">size_t</span> lda, T <span class="type">const</span>* B, <span class="type">size_t</span> ldb,</span></span></span><br><span class="line"><span class="params"><span class="function">                               T beta, T* C, <span class="type">size_t</span> ldc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Compute the row and column of C that this thread is responsible for.</span></span><br><span class="line">    <span class="type">size_t</span> <span class="type">const</span> C_col_idx&#123;blockIdx.x * blockDim.x + threadIdx.x&#125;;</span><br><span class="line">    <span class="type">size_t</span> <span class="type">const</span> C_row_idx&#123;blockIdx.y * blockDim.y + threadIdx.y&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Each thread compute</span></span><br><span class="line">    <span class="comment">// C[C_row_idx, C_col_idx] = alpha * A[C_row_idx, :] * B[:, C_col_idx] +</span></span><br><span class="line">    <span class="comment">// beta * C[C_row_idx, C_col_idx].</span></span><br><span class="line">    <span class="keyword">if</span> (C_row_idx &lt; m &amp;&amp; C_col_idx &lt; n)</span><br><span class="line">    &#123;</span><br><span class="line">        T sum&#123;<span class="built_in">static_cast</span>&lt;T&gt;(<span class="number">0</span>)&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> k_idx&#123;<span class="number">0U</span>&#125;; k_idx &lt; k; ++k_idx)</span><br><span class="line">        &#123;</span><br><span class="line">            sum += A[C_row_idx * lda + k_idx] * B[k_idx * ldb + C_col_idx];</span><br><span class="line">        &#125;</span><br><span class="line">        C[C_row_idx * ldc + C_col_idx] =</span><br><span class="line">            alpha * sum + beta * C[C_row_idx * ldc + C_col_idx];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">launch_gemm_kernel_coalesced</span><span class="params">(<span class="type">size_t</span> m, <span class="type">size_t</span> n, <span class="type">size_t</span> k, T <span class="type">const</span>* alpha,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  T <span class="type">const</span>* A, <span class="type">size_t</span> lda, T <span class="type">const</span>* B,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">size_t</span> ldb, T <span class="type">const</span>* beta, T* C, <span class="type">size_t</span> ldc,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  cudaStream_t stream)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    dim3 <span class="type">const</span> block_dim&#123;<span class="number">32U</span>, <span class="number">8U</span>, <span class="number">1U</span>&#125;;</span><br><span class="line">    dim3 <span class="type">const</span> grid_dim&#123;</span><br><span class="line">        (<span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span> <span class="type">int</span>&gt;(n) + block_dim.x - <span class="number">1U</span>) / block_dim.x,</span><br><span class="line">        (<span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span> <span class="type">int</span>&gt;(m) + block_dim.y - <span class="number">1U</span>) / block_dim.y, <span class="number">1U</span>&#125;;</span><br><span class="line">    gemm_coalesced&lt;T&gt;&lt;&lt;&lt;grid_dim, block_dim, <span class="number">0U</span>, stream&gt;&gt;&gt;(</span><br><span class="line">        m, n, k, *alpha, A, lda, B, ldb, *beta, C, ldc);</span><br><span class="line">    <span class="built_in">CHECK_LAST_CUDA_ERROR</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">gemm_cpu</span><span class="params">(<span class="type">size_t</span> m, <span class="type">size_t</span> n, <span class="type">size_t</span> k, T alpha, T <span class="type">const</span>* A, <span class="type">size_t</span> lda,</span></span></span><br><span class="line"><span class="params"><span class="function">              T <span class="type">const</span>* B, <span class="type">size_t</span> ldb, T beta, T* C, <span class="type">size_t</span> ldc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; m; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> j&#123;<span class="number">0U</span>&#125;; j &lt; n; ++j)</span><br><span class="line">        &#123;</span><br><span class="line">            T sum&#123;<span class="built_in">static_cast</span>&lt;T&gt;(<span class="number">0</span>)&#125;;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> k_idx&#123;<span class="number">0U</span>&#125;; k_idx &lt; k; ++k_idx)</span><br><span class="line">            &#123;</span><br><span class="line">                sum += A[i * lda + k_idx] * B[k_idx * ldb + j];</span><br><span class="line">            &#125;</span><br><span class="line">            C[i * ldc + j] = alpha * sum + beta * C[i * ldc + j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">verify_outputs</span><span class="params">(<span class="type">size_t</span> m, <span class="type">size_t</span> n, <span class="type">size_t</span> ldc, T <span class="type">const</span>* C, T <span class="type">const</span>* C_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">                    T abs_error_tol)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; m; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> j&#123;<span class="number">0U</span>&#125;; j &lt; n; ++j)</span><br><span class="line">        &#123;</span><br><span class="line">            T <span class="type">const</span> abs_error&#123;std::<span class="built_in">abs</span>(C[i * ldc + j] - C_ref[i * ldc + j])&#125;;</span><br><span class="line">            <span class="keyword">if</span> (abs_error &gt; abs_error_tol)</span><br><span class="line">            &#123;</span><br><span class="line">                std::cerr &lt;&lt; <span class="string">&quot;Error: i = &quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;, j = &quot;</span> &lt;&lt; j</span><br><span class="line">                          &lt;&lt; <span class="string">&quot;, abs_error = &quot;</span> &lt;&lt; abs_error &lt;&lt; std::endl;</span><br><span class="line">                std::<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">size_t</span> <span class="type">const</span> m&#123;<span class="number">1024U</span>&#125;;</span><br><span class="line">    <span class="type">size_t</span> <span class="type">const</span> n&#123;<span class="number">1024U</span>&#125;;</span><br><span class="line">    <span class="type">size_t</span> <span class="type">const</span> k&#123;<span class="number">1024U</span>&#125;;</span><br><span class="line">    <span class="type">float</span> <span class="type">const</span> alpha&#123;<span class="number">1.0f</span>&#125;;</span><br><span class="line">    <span class="type">float</span> <span class="type">const</span> beta&#123;<span class="number">0.0f</span>&#125;;</span><br><span class="line">    <span class="type">float</span> <span class="type">const</span> abs_error_tol&#123;<span class="number">1e-5</span>f&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> <span class="type">const</span> lda&#123;k&#125;;</span><br><span class="line">    <span class="type">size_t</span> <span class="type">const</span> ldb&#123;n&#125;;</span><br><span class="line">    <span class="type">size_t</span> <span class="type">const</span> ldc&#123;n&#125;;</span><br><span class="line"></span><br><span class="line">    cudaStream_t stream;</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaStreamCreate</span>(&amp;stream));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate memory on the host.</span></span><br><span class="line">    <span class="type">float</span>* A_host&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">    <span class="type">float</span>* B_host&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">    <span class="type">float</span>* C_host&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">    <span class="type">float</span>* C_host_from_device&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaMallocHost</span>(&amp;A_host, m * lda * <span class="built_in">sizeof</span>(<span class="type">float</span>)));</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaMallocHost</span>(&amp;B_host, k * ldb * <span class="built_in">sizeof</span>(<span class="type">float</span>)));</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaMallocHost</span>(&amp;C_host, m * ldc * <span class="built_in">sizeof</span>(<span class="type">float</span>)));</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(</span><br><span class="line">        <span class="built_in">cudaMallocHost</span>(&amp;C_host_from_device, m * ldc * <span class="built_in">sizeof</span>(<span class="type">float</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize A and B.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; m; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> j&#123;<span class="number">0U</span>&#125;; j &lt; k; ++j)</span><br><span class="line">        &#123;</span><br><span class="line">            A_host[i * lda + j] = <span class="built_in">static_cast</span>&lt;<span class="type">float</span>&gt;(i + j);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; k; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> j&#123;<span class="number">0U</span>&#125;; j &lt; n; ++j)</span><br><span class="line">        &#123;</span><br><span class="line">            B_host[i * ldb + j] = <span class="built_in">static_cast</span>&lt;<span class="type">float</span>&gt;(i + j);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate memory on the device.</span></span><br><span class="line">    <span class="type">float</span>* A_device&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">    <span class="type">float</span>* B_device&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">    <span class="type">float</span>* C_device&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaMalloc</span>(&amp;A_device, m * lda * <span class="built_in">sizeof</span>(<span class="type">float</span>)));</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaMalloc</span>(&amp;B_device, k * ldb * <span class="built_in">sizeof</span>(<span class="type">float</span>)));</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaMalloc</span>(&amp;C_device, m * ldc * <span class="built_in">sizeof</span>(<span class="type">float</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copy A and B to the device.</span></span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaMemcpy</span>(A_device, A_host, m * lda * <span class="built_in">sizeof</span>(<span class="type">float</span>),</span><br><span class="line">                                cudaMemcpyHostToDevice));</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaMemcpy</span>(B_device, B_host, k * ldb * <span class="built_in">sizeof</span>(<span class="type">float</span>),</span><br><span class="line">                                cudaMemcpyHostToDevice));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Run the CPU version.</span></span><br><span class="line">    <span class="built_in">gemm_cpu</span>(m, n, k, alpha, A_host, lda, B_host, ldb, beta, C_host, ldc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Launch the kernel.</span></span><br><span class="line">    <span class="built_in">launch_gemm_kernel_non_coalesced</span>(m, n, k, &amp;alpha, A_device, lda, B_device,</span><br><span class="line">                                     ldb, &amp;beta, C_device, ldc, stream);</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaStreamSynchronize</span>(stream));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copy C from the device.</span></span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaMemcpy</span>(C_host_from_device, C_device,</span><br><span class="line">                                m * ldc * <span class="built_in">sizeof</span>(<span class="type">float</span>),</span><br><span class="line">                                cudaMemcpyDeviceToHost));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Compare the results.</span></span><br><span class="line">    <span class="built_in">verify_outputs</span>(m, n, ldc, C_host_from_device, C_host, abs_error_tol);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Launch the kernel.</span></span><br><span class="line">    <span class="built_in">launch_gemm_kernel_coalesced</span>(m, n, k, &amp;alpha, A_device, lda, B_device, ldb,</span><br><span class="line">                                 &amp;beta, C_device, ldc, stream);</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaStreamSynchronize</span>(stream));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copy C from the device.</span></span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaMemcpy</span>(C_host_from_device, C_device,</span><br><span class="line">                                m * ldc * <span class="built_in">sizeof</span>(<span class="type">float</span>),</span><br><span class="line">                                cudaMemcpyDeviceToHost));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Compare the results.</span></span><br><span class="line">    <span class="built_in">verify_outputs</span>(m, n, ldc, C_host_from_device, C_host, abs_error_tol);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Free the memory.</span></span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaFree</span>(A_device));</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaFree</span>(B_device));</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaFree</span>(C_device));</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaFreeHost</span>(A_host));</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaFreeHost</span>(B_host));</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaFreeHost</span>(C_host));</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaFreeHost</span>(C_host_from_device));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To build the example using <code>nvcc</code> and profile the example using Nsight Compute, please run the following commands.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ nvcc gemm_naive.cu -o gemm_naive</span><br><span class="line">$ ncu --<span class="built_in">set</span> full -f -o gemm_naive gemm_naive</span><br></pre></td></tr></table></figure>

<p>To view the profiling results using Nsight Compute GUI, please run the following command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ncu-ui</span><br></pre></td></tr></table></figure>

<img src="/images/blog/2024-01-02-Docker-Nsight-Compute/gemm_native.png" class="box px-0 py-0 ml-auto mr-auto" width="960" title="Nsight Compute Naive GEMM Profile Details" alt="Nsight Compute Naive GEMM Profile Details">
<br>

<p>From the Nsight Compute profile details, we could see that the first version of the kernel <code>gemm_non_coalesced</code> took 9.85 ms, whereas the second version of the kernel <code>gemm_coalesced</code> took 1.20 ms. Despite the fact that neither of the two kernels is well optimized, Nsight Compute found a lot of issues with the two kernels. Specifically, the kernel <code>gemm_non_coalesced</code> is very memory-bound and Nsight Compute tells us that “This kernel has non-coalesced global accesses resulting in a total of 941359104 excessive sectors (85% of the total 1109393408 sectors)”. For example, for the kernel <code>gemm_non_coalesced</code>, L1/TEX Cache statistics shows that global load takes 16.51 sector per request ($\frac{32 \times 1 + 1}{2} = 16.5$), and global store takes 32 sectors per request ($\frac{32 \times 1}{1} = 32$), whereas for the kernel <code>gemm_coalesced</code>, which fixed the global memory coalesced access issue, global load takes 2.5 sector per request ($\frac{32 \times 4 / 32 + 1}{2} = 2.5$), and global store takes 4 sectors per request ($\frac{32 \times 4 / 32}{1} = 4$).</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/leimao/Nsight-Compute-Docker-Image">Nsight Compute Docker Image</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>Nsight Compute In Docker</p><p><a href="https://leimao.github.io/blog/Docker-Nsight-Compute/">https://leimao.github.io/blog/Docker-Nsight-Compute/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Lei Mao</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>01-02-2024</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>01-02-2024</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <div><a class="link-muted" rel="tag" href="/tags/CUDA/">CUDA,</a> </div><div><a class="link-muted" rel="tag" href="/tags/NVIDIA/">NVIDIA,</a> </div><div><a class="link-muted" rel="tag" href="/tags/Docker/">Docker,</a> </div><div><a class="link-muted" rel="tag" href="/tags/Nsight-Compute/">Nsight Compute </a> </div></div></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=61b5930d440224001908310c&amp;product=inline-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered has-text-weight-normal">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" data-type="paypal" onclick="document.getElementById(&#039;paypal-donate-form&#039;).submit()"><span class="icon is-small"><i class="fab fa-paypal"></i></span><span>Paypal</span></a><form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank" rel="noopener" id="paypal-donate-form"><input type="hidden" name="cmd" value="_donations"><input type="hidden" name="business" value="SSVSLEH4X85LU"><input type="hidden" name="currency_code" value="USD"></form><a class="button donate" href="https://www.buymeacoffee.com/leimao" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>Buy me a coffee</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/life/Don-Edwards-San-Francisco-Bay-National-Wildlife-Refuge/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Don Edwards San Francisco Bay National Wildlife Refuge 徒步</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/article/How-To-Debug-Deep-Learning-Inference-Applications/"><span class="level-item">How To Debug Deep Learning Inference Applications</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card" id="comment-card"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="comment-block"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://leimao.github.io/blog/Docker-Nsight-Compute/';
            this.page.identifier = '/blog/Docker-Nsight-Compute/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'leimao-github-io' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/author_images/Lei-Bio-Medium.jpg" alt="Lei Mao"></figure><p class="title is-size-4 is-block" style="line-height:inherit;margin-bottom:0.30rem;">Lei Mao</p><p class="is-block" style="white-space: pre-line; font-style: italic; margin-bottom: 0.50rem; font-size: 0.8em">Artificial Intelligence
Machine Learning
Computer Science
</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Santa Clara, California</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">733</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">453</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/leimao" target="_blank" rel="noopener"><i class="fab fa-github"></i>  Follow</a> <a class="level-item button is-primary is-rounded" href="https://github.com/sponsors/leimao" target="_blank" rel="noopener"><i class="fas fa-heart"></i>  Sponsor</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/leimao"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/matchaleimao"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/lei-mao/"><i class="fab fa-linkedin"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:dukeleimao@gmail.com"><i class="fas fa-envelope-square"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="G.Scholar" href="https://scholar.google.com/citations?user=R2VUf7YAAAAJ"><i class="ai ai-google-scholar-square"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Introduction"><span class="level-left"><span class="level-item">1</span><span class="level-item">Introduction</span></span></a></li><li><a class="level is-mobile" href="#Nsight-Compute"><span class="level-left"><span class="level-item">2</span><span class="level-item">Nsight Compute</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Build-Docker-Image"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">Build Docker Image</span></span></a></li><li><a class="level is-mobile" href="#Upload-Docker-Image"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">Upload Docker Image</span></span></a></li><li><a class="level is-mobile" href="#Pull-Docker-Image"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">Pull Docker Image</span></span></a></li><li><a class="level is-mobile" href="#Run-Docker-Container"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">Run Docker Container</span></span></a></li><li><a class="level is-mobile" href="#Run-Nsight-Compute"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">Run Nsight Compute</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Examples"><span class="level-left"><span class="level-item">3</span><span class="level-item">Examples</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Non-Coalesced-Memory-Access-VS-Coalesced-Memory-Access"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">Non-Coalesced Memory Access VS Coalesced Memory Access</span></span></a></li></ul></li><li><a class="level is-mobile" href="#References"><span class="level-left"><span class="level-item">4</span><span class="level-item">References</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget"><div class="g-ads-x"><div class="card-content"><div class="menu"><h3 class="menu-label">Advertisement</h3></div><br><center><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CWYDCK3L&amp;placement=leimaogithubio" id="_carbonads_js"></script></center></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/favicon/android-chrome-512x512.png" alt="Lei Mao&#039;s Log Book" height="28"></a><p class="is-size-7"><span>&copy; 2017-2024 Lei Mao</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Site UV: <span id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></span></span> <span id="busuanzi_container_site_pv">Site PV: <span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></span></span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="GitHub" href="https://github.com/leimao"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script src="/js/night.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>