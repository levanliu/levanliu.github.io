<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="twitter:image:src" content="https://levanliu.github.io/images/favicon/android-chrome-512x512.png"><meta name="referrer" content="no-referrer-when-downgrade"><title>TensorRT Custom Plugin Example - Lei Mao&#039;s Log Book</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="Lei Mao&#039;s Log Book"><meta name="msapplication-TileImage" content="/images/favicon/android-chrome-192x192.png"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Lei Mao&#039;s Log Book"><meta name="apple-mobile-web-app-status-bar-style" content="default"><link rel="apple-touch-icon" sizes="192x192" href="/images/favicon/android-chrome-192x192.png"><link rel="apple-touch-icon" sizes="512x512" href="/images/favicon/android-chrome-512x512.png"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="16x16" href="/images/favicon/favicon-16x16.png"><link rel="apple-touch-icon" sizes="32x32" href="/images/favicon/favicon-32x32.png"><meta name="description" content="TensorRT Custom Plugin Implementation and Integration"><meta property="og:type" content="blog"><meta property="og:title" content="TensorRT Custom Plugin Example"><meta property="og:url" content="https://levanliu.github.io/blog/TensorRT-Custom-Plugin-Example/"><meta property="og:site_name" content="Lei Mao&#039;s Log Book"><meta property="og:description" content="TensorRT Custom Plugin Implementation and Integration"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://levanliu.github.io/images/favicon/android-chrome-512x512.png"><meta property="article:published_time" content="2024-01-27T08:00:00.000Z"><meta property="article:modified_time" content="2024-01-27T08:00:00.000Z"><meta property="article:author" content="Lei Mao"><meta property="article:tag" content="CPP"><meta property="article:tag" content="CUDA"><meta property="article:tag" content="NVIDIA"><meta property="article:tag" content="TensorRT"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://levanliu.github.io/images/favicon/android-chrome-512x512.png"><meta property="twitter:creator" content="@matchalevanliu"><meta property="twitter:site" content="Lei Mao&#039;s Log Book"><meta property="fb:admins" content="dukelevanliu"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://levanliu.github.io/blog/TensorRT-Custom-Plugin-Example/"},"headline":"TensorRT Custom Plugin Example","image":["https://levanliu.github.io/images/favicon/android-chrome-512x512.png"],"datePublished":"2024-01-27T08:00:00.000Z","dateModified":"2024-01-27T08:00:00.000Z","author":{"@type":"Person","name":"Lei Mao"},"publisher":{"@type":"Organization","name":"Lei Mao's Log Book","logo":{"@type":"ImageObject","url":"https://levanliu.github.io/images/favicon/android-chrome-512x512.png"}},"description":"TensorRT Custom Plugin Implementation and Integration"}</script><link rel="canonical" href="https://levanliu.github.io/blog/TensorRT-Custom-Plugin-Example/"><link rel="alternate" href="/atom.xml" title="Lei Mao&#039;s Log Book" type="application/atom+xml"><link rel="icon" href="/images/favicon/favicon.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons/css/academicons.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=PT+Sans+Narrow:wght@400;700&amp;family=PT+Serif"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-EJY6FXZBCB" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-EJY6FXZBCB');</script><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><script src="//m.servedby-buysellads.com/monetization.custom.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/favicon/android-chrome-512x512.png" alt="Lei Mao&#039;s Log Book" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Lei Mao&#039;s Log Book</a><a class="navbar-item" href="/curriculum">Curriculum</a><a class="navbar-item" href="/blog">Blog</a><a class="navbar-item" href="/article">Articles</a><a class="navbar-item" href="/project">Projects</a><a class="navbar-item" href="/publication">Publications</a><a class="navbar-item" href="/reading">Readings</a><a class="navbar-item" href="/life">Life</a><a class="navbar-item" href="/essay">Essay</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/faq">FAQs</a></div><div class="navbar-end"><a class="navbar-item night" id="night-nav" title="Switch Color Scheme" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/levanliu"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Gitter" href="https://gitter.im/levanliu/community"><i class="fab fa-gitter"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><div class="card-content"><center><div class="bsa-standard" id="carbon-ad-01"></div><script>            (function() {             if (typeof _bsa !== 'undefined' && _bsa) {                 _bsa.init('custom', 'CWYD65QY', 'placement:levanliugithubio-standard', {                     target: '#carbon-ad-01',                     template: `             <a href='##link##' class='native-banner' style='background: ##backgroundColor##' rel='sponsored noopener' target='_blank' title='##company## — ##tagline##'>                 <img class='native-img' width='125' src='##logo##' />                 <div class='native-main'>                     <div class='native-details' style='                             color: ##textColor##;                             border-left: solid 1px ##textColor##;                         '>                         <span class='native-company'>Sponsored by ##company##</span>                         <span class='native-desc'>##description##</span>                     </div>                     <span class='native-cta' style='                             color: ##ctaTextColor##;                             background-color: ##ctaBackgroundColor##;                         '>##callToAction##</span>                 </div>             </a>             `,                 });                 }             })();         </script></center></div></div><div class="card"><article class="card-content article" role="article"><h1 class="title is-size-3" style="font-family: 'PT Sans Narrow', sans-serif">TensorRT Custom Plugin Example</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left" style="margin-bottom: 0.50rem"><span class="level-item"><i class="far fa-calendar-alt"> </i><time dateTime="2024-01-27T08:00:00.000Z" title="2024-01-27T08:00:00.000Z">01-27-2024</time></span><span class="level-item is-hidden-mobile"><i class="far fa-calendar-check"> </i><time dateTime="2024-01-27T08:00:00.000Z" title="2024-01-27T08:00:00.000Z">01-27-2024</time></span><span class="level-item"><i class="far fa-folder-open has-text-grey"></i> <a class="link-muted" href="/blog/">blog</a></span><span class="level-item"><i class="far fa-clock"></i> 33 minutes read (About 4882 words)</span><span class="level-item" id="busuanzi_container_page_pv"><i class="far fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>&nbsp;visits</span></div></div><div class="content" style="margin-top: 1.0rem"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>TensorRT is a high-performance deep learning inference SDK that accelerates deep learning inference on NVIDIA GPUs. It allows user to create custom plugins for the neural network layers that have not been supported by TensorRT.</p>
<p>In this blog post, I would like to demonstrate how to implement and integrate a custom plugin into TensorRT using a concrete and self-contained example.</p>
<h2 id="Identity-ONNX-Model"><a href="#Identity-ONNX-Model" class="headerlink" title="Identity ONNX Model"></a>Identity ONNX Model</h2><p>To make the custom plugin implementation and integration less complicated, we created a simle identity ONNX model that consists of three <code>Conv</code> nodes whose weights and attributes are orchestrated so that the convolution operation is a simple identity operation. The second <code>Conv</code> node in the ONNX is replaced with a custom ONNX node <code>IdentityConv</code> that is not defined in the ONNX operator set. Without the custom plugin for the <code>IdentityConv</code> node, TensorRT engine cannot be created from the ONNX model.</p>
<figure class="highlight python"><figcaption><span>create_identity_neural_network.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create a neural network that consists of three identity convolutional layers.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> onnx</span><br><span class="line"><span class="keyword">import</span> onnx_graphsurgeon <span class="keyword">as</span> gs</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line"></span><br><span class="line">    opset_version = <span class="number">13</span></span><br><span class="line">    data_directory_path = <span class="string">&quot;data&quot;</span></span><br><span class="line">    onnx_file_name = <span class="string">&quot;identity_neural_network.onnx&quot;</span></span><br><span class="line">    onnx_file_path = os.path.join(data_directory_path, onnx_file_name)</span><br><span class="line"></span><br><span class="line">    input_shape = (<span class="number">1</span>, <span class="number">3</span>, <span class="number">480</span>, <span class="number">960</span>)</span><br><span class="line">    input_data = np.random.rand(*input_shape).astype(np.float32)</span><br><span class="line">    input_channels = input_shape[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># configure a dummy conv:</span></span><br><span class="line">    weights_shape = (input_channels, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    num_groups = input_channels</span><br><span class="line">    weights_data = np.ones(weights_shape, dtype=np.float32)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># generate ONNX model</span></span><br><span class="line">    X0 = gs.Variable(name=<span class="string">&quot;X0&quot;</span>, dtype=np.float32, shape=input_shape)</span><br><span class="line">    W0 = gs.Constant(name=<span class="string">&quot;W0&quot;</span>, values=weights_data)</span><br><span class="line">    X1 = gs.Variable(name=<span class="string">&quot;X1&quot;</span>, dtype=np.float32, shape=input_shape)</span><br><span class="line">    W1 = gs.Constant(name=<span class="string">&quot;W1&quot;</span>, values=weights_data)</span><br><span class="line">    X2 = gs.Variable(name=<span class="string">&quot;X2&quot;</span>, dtype=np.float32, shape=input_shape)</span><br><span class="line">    W2 = gs.Constant(name=<span class="string">&quot;W2&quot;</span>, values=weights_data)</span><br><span class="line">    X3 = gs.Variable(name=<span class="string">&quot;X3&quot;</span>, dtype=np.float32, shape=input_shape)</span><br><span class="line"></span><br><span class="line">    node_1 = gs.Node(name=<span class="string">&quot;Conv-1&quot;</span>, op=<span class="string">&quot;Conv&quot;</span>,</span><br><span class="line">                   inputs=[X0, W0],</span><br><span class="line">                   outputs=[X1],</span><br><span class="line">                   attrs=&#123;</span><br><span class="line">                       <span class="string">&quot;kernel_shape&quot;</span>: [<span class="number">1</span>, <span class="number">1</span>],</span><br><span class="line">                       <span class="string">&quot;strides&quot;</span>: [<span class="number">1</span>, <span class="number">1</span>],</span><br><span class="line">                       <span class="string">&quot;pads&quot;</span>: [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">                       <span class="string">&quot;group&quot;</span>: num_groups</span><br><span class="line">                   &#125;)</span><br><span class="line">    <span class="comment"># Use an custom operator IdentityConv Instead.</span></span><br><span class="line">    <span class="comment"># This operator is not defined by ONNX and cannot be parsed by ONNX parser without custom plugin.</span></span><br><span class="line">    <span class="comment"># node_2 = gs.Node(name=&quot;Conv-2&quot;, op=&quot;Conv&quot;,</span></span><br><span class="line">    <span class="comment">#                inputs=[X1, W1],</span></span><br><span class="line">    <span class="comment">#                outputs=[X2],</span></span><br><span class="line">    <span class="comment">#                attrs=&#123;</span></span><br><span class="line">    <span class="comment">#                    &quot;kernel_shape&quot;: [1, 1],</span></span><br><span class="line">    <span class="comment">#                    &quot;strides&quot;: [1, 1],</span></span><br><span class="line">    <span class="comment">#                    &quot;pads&quot;: [0, 0, 0, 0],</span></span><br><span class="line">    <span class="comment">#                    &quot;group&quot;: num_groups</span></span><br><span class="line">    <span class="comment">#                &#125;)</span></span><br><span class="line">    node_2 = gs.Node(name=<span class="string">&quot;Conv-2&quot;</span>, op=<span class="string">&quot;IdentityConv&quot;</span>,</span><br><span class="line">                   inputs=[X1, W1],</span><br><span class="line">                   outputs=[X2],</span><br><span class="line">                   attrs=&#123;</span><br><span class="line">                       <span class="string">&quot;kernel_shape&quot;</span>: [<span class="number">1</span>, <span class="number">1</span>],</span><br><span class="line">                       <span class="string">&quot;strides&quot;</span>: [<span class="number">1</span>, <span class="number">1</span>],</span><br><span class="line">                       <span class="string">&quot;pads&quot;</span>: [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">                       <span class="string">&quot;group&quot;</span>: num_groups</span><br><span class="line">                   &#125;)</span><br><span class="line">    node_3 = gs.Node(name=<span class="string">&quot;Conv-3&quot;</span>, op=<span class="string">&quot;Conv&quot;</span>,</span><br><span class="line">                   inputs=[X2, W2],</span><br><span class="line">                   outputs=[X3],</span><br><span class="line">                   attrs=&#123;</span><br><span class="line">                       <span class="string">&quot;kernel_shape&quot;</span>: [<span class="number">1</span>, <span class="number">1</span>],</span><br><span class="line">                       <span class="string">&quot;strides&quot;</span>: [<span class="number">1</span>, <span class="number">1</span>],</span><br><span class="line">                       <span class="string">&quot;pads&quot;</span>: [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">                       <span class="string">&quot;group&quot;</span>: num_groups</span><br><span class="line">                   &#125;)</span><br><span class="line"></span><br><span class="line">    graph = gs.Graph(nodes=[node_1, node_2, node_3], inputs=[X0], outputs=[X3], opset=opset_version)</span><br><span class="line">    model = gs.export_onnx(graph)</span><br><span class="line">    <span class="comment"># Shape inference does not quite work here because of the custom operator.</span></span><br><span class="line">    <span class="comment"># model = onnx.shape_inference.infer_shapes(model)</span></span><br><span class="line">    onnx.save(model, onnx_file_path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h2 id="IdentityConv-Custom-Plugin-Implementation"><a href="#IdentityConv-Custom-Plugin-Implementation" class="headerlink" title="IdentityConv Custom Plugin Implementation"></a>IdentityConv Custom Plugin Implementation</h2><p>The custom plugin class has to be derived from the <code>nvinfer1::IPluginV2IOExt</code> or <code>nvinfer1::IPluginV2DynamicExt</code> class. The <code>nvinfer1::IPluginV2Ext</code> class has been deprecated and should not be used. In this example, the <code>nvinfer1::IPluginV2IOExt</code> class is used.</p>
<figure class="highlight c++"><figcaption><span>IdentityConvPlugin.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> TENSORRT_IDENTITY_CONV_PLUGIN_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TENSORRT_IDENTITY_CONV_PLUGIN_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cuda_runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;NvInferRuntimePlugin.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">char</span> <span class="type">const</span>* <span class="type">const</span> kIDENTITY_CONV_PLUGIN_NAME&#123;<span class="string">&quot;IdentityConv&quot;</span>&#125;;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">char</span> <span class="type">const</span>* <span class="type">const</span> kIDENTITY_CONV_PLUGIN_VERSION&#123;<span class="string">&quot;1&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> nvinfer1</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">namespace</span> plugin</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">IdentityConvParameters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int32_t</span> group;</span><br><span class="line">    nvinfer1::DataType dtype;</span><br><span class="line">    <span class="type">int32_t</span> channelSize;</span><br><span class="line">    <span class="type">int32_t</span> height;</span><br><span class="line">    <span class="type">int32_t</span> width;</span><br><span class="line">    <span class="type">size_t</span> dtypeBytes;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IdentityConv</span> : <span class="keyword">public</span> nvinfer1::IPluginV2IOExt</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">IdentityConv</span>(IdentityConvParameters params);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">IdentityConv</span>(<span class="type">void</span> <span class="type">const</span>* data, <span class="type">size_t</span> length);</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">IdentityConv</span>() <span class="keyword">override</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">getNbOutputs</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">nvinfer1::Dims <span class="title">getOutputDimensions</span><span class="params">(<span class="type">int32_t</span> index,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       nvinfer1::Dims <span class="type">const</span>* inputs,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       <span class="type">int32_t</span> nbInputDims)</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">terminate</span><span class="params">()</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">getWorkspaceSize</span><span class="params">(<span class="type">int32_t</span> maxBatchSize)</span> <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">enqueue</span><span class="params">(<span class="type">int32_t</span> batchSize, <span class="type">void</span> <span class="type">const</span>* <span class="type">const</span>* inputs,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">void</span>* <span class="type">const</span>* outputs, <span class="type">void</span>* workspace,</span></span></span><br><span class="line"><span class="params"><span class="function">                    cudaStream_t stream)</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">getSerializationSize</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">serialize</span><span class="params">(<span class="type">void</span>* buffer)</span> <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">configurePlugin</span><span class="params">(nvinfer1::PluginTensorDesc <span class="type">const</span>* in, <span class="type">int32_t</span> nbInput,</span></span></span><br><span class="line"><span class="params"><span class="function">                         nvinfer1::PluginTensorDesc <span class="type">const</span>* out,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="type">int32_t</span> nbOutput)</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">supportsFormatCombination</span><span class="params">(<span class="type">int32_t</span> pos,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   nvinfer1::PluginTensorDesc <span class="type">const</span>* inOut,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">int32_t</span> nbInputs,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">int32_t</span> nbOutputs)</span> <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="type">const</span>* <span class="title">getPluginType</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="type">const</span>* <span class="title">getPluginVersion</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">IPluginV2IOExt* <span class="title">clone</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">nvinfer1::DataType</span></span><br><span class="line"><span class="function">    <span class="title">getOutputDataType</span><span class="params">(<span class="type">int32_t</span> index, nvinfer1::DataType <span class="type">const</span>* inputType,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">int32_t</span> nbInputs)</span> <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setPluginNamespace</span><span class="params">(<span class="type">char</span> <span class="type">const</span>* pluginNamespace)</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="type">const</span>* <span class="title">getPluginNamespace</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isOutputBroadcastAcrossBatch</span><span class="params">(<span class="type">int32_t</span> outputIndex,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      <span class="type">bool</span> <span class="type">const</span>* inputIsBroadcasted,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      <span class="type">int32_t</span> nbInputs)</span> <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">canBroadcastInputAcrossBatch</span><span class="params">(<span class="type">int32_t</span> inputIndex)</span> <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">deserialize</span><span class="params">(<span class="type">uint8_t</span> <span class="type">const</span>* data, <span class="type">size_t</span> length)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TensorRT plugin parameters.</span></span><br><span class="line">    IdentityConvParameters mParams;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> <span class="type">const</span>* mPluginNamespace;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace plugin</span></span><br><span class="line">&#125; <span class="comment">// namespace nvinfer1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// TENSORRT_IDENTITY_CONV_PLUGIN_H</span></span></span><br></pre></td></tr></table></figure>

<p>To perform the <code>IdentityConv</code> operation, the custom plugin class has to override the <code>nvinfer1::IPluginV2IOExt::enqueue</code> method. In our case, we simply copy the input tensor to the output tensor using <code>cudaMemcpyAsync</code>.</p>
<figure class="highlight c++"><figcaption><span>IdentityConvPlugin.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;exception&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;NvInferRuntime.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;NvInferRuntimePlugin.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;IdentityConvPlugin.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;PluginUtils.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> nvinfer1</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">namespace</span> plugin</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Write values into buffer</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type, <span class="keyword">typename</span> BufferType&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(BufferType*&amp; buffer, Type <span class="type">const</span>&amp; val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">static_assert</span>(<span class="built_in">sizeof</span>(BufferType) == <span class="number">1</span>, <span class="string">&quot;BufferType must be a 1 byte type.&quot;</span>);</span><br><span class="line">    std::<span class="built_in">memcpy</span>(buffer, &amp;val, <span class="built_in">sizeof</span>(Type));</span><br><span class="line">    buffer += <span class="built_in">sizeof</span>(Type);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Read values from buffer</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> OutType, <span class="keyword">typename</span> BufferType&gt;</span><br><span class="line"><span class="function">OutType <span class="title">read</span><span class="params">(BufferType <span class="type">const</span>*&amp; buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">static_assert</span>(<span class="built_in">sizeof</span>(BufferType) == <span class="number">1</span>, <span class="string">&quot;BufferType must be a 1 byte type.&quot;</span>);</span><br><span class="line">    OutType val&#123;&#125;;</span><br><span class="line">    std::<span class="built_in">memcpy</span>(&amp;val, <span class="built_in">static_cast</span>&lt;<span class="type">void</span> <span class="type">const</span>*&gt;(buffer), <span class="built_in">sizeof</span>(OutType));</span><br><span class="line">    buffer += <span class="built_in">sizeof</span>(OutType);</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">IdentityConv::<span class="built_in">IdentityConv</span>(IdentityConvParameters params) : mParams&#123;params&#125; &#123;&#125;</span><br><span class="line"></span><br><span class="line">IdentityConv::<span class="built_in">IdentityConv</span>(<span class="type">void</span> <span class="type">const</span>* data, <span class="type">size_t</span> length)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">deserialize</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span> <span class="type">const</span>*&gt;(data), length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IdentityConv::deserialize</span><span class="params">(<span class="type">uint8_t</span> <span class="type">const</span>* data, <span class="type">size_t</span> length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// In our simple use case, even though there is no parameter used for this</span></span><br><span class="line">    <span class="comment">// plugin, we deserialize and serialize some attributes for demonstration</span></span><br><span class="line">    <span class="comment">// purposes.</span></span><br><span class="line">    <span class="type">uint8_t</span> <span class="type">const</span>* d&#123;data&#125;;</span><br><span class="line">    mParams.group = <span class="built_in">read</span>&lt;<span class="type">int32_t</span>&gt;(d);</span><br><span class="line">    mParams.dtype = <span class="built_in">read</span>&lt;nvinfer1::DataType&gt;(d);</span><br><span class="line">    mParams.channelSize = <span class="built_in">read</span>&lt;<span class="type">int32_t</span>&gt;(d);</span><br><span class="line">    mParams.height = <span class="built_in">read</span>&lt;<span class="type">int32_t</span>&gt;(d);</span><br><span class="line">    mParams.width = <span class="built_in">read</span>&lt;<span class="type">int32_t</span>&gt;(d);</span><br><span class="line">    mParams.dtypeBytes = <span class="built_in">read</span>&lt;<span class="type">size_t</span>&gt;(d);</span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(d == data + length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">IdentityConv::getNbOutputs</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span>&#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IdentityConv::configurePlugin</span><span class="params">(nvinfer1::PluginTensorDesc <span class="type">const</span>* in,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">int32_t</span> nbInput,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   nvinfer1::PluginTensorDesc <span class="type">const</span>* out,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">int32_t</span> nbOutput)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Communicates the number of inputs and outputs, dimensions, and datatypes</span></span><br><span class="line">    <span class="comment">// of all inputs and outputs, broadcast information for all inputs and</span></span><br><span class="line">    <span class="comment">// outputs, the chosen plugin format, and maximum batch size. At this point,</span></span><br><span class="line">    <span class="comment">// the plugin sets up its internal state and selects the most appropriate</span></span><br><span class="line">    <span class="comment">// algorithm and data structures for the given configuration. Note: Resource</span></span><br><span class="line">    <span class="comment">// allocation is not allowed in this API because it causes a resource leak.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// This member function will only be called during engine build time.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Validate input arguments.</span></span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(nbInput == <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(nbOutput == <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(in[<span class="number">0</span>].dims.nbDims == <span class="number">3</span>);</span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(out[<span class="number">0</span>].dims.nbDims == <span class="number">3</span>);</span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(in[<span class="number">0</span>].dims.d[<span class="number">0</span>] == out[<span class="number">0</span>].dims.d[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(in[<span class="number">0</span>].dims.d[<span class="number">1</span>] == out[<span class="number">0</span>].dims.d[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(in[<span class="number">0</span>].dims.d[<span class="number">2</span>] == out[<span class="number">0</span>].dims.d[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(in[<span class="number">0</span>].type == out[<span class="number">0</span>].type);</span><br><span class="line"></span><br><span class="line">    mParams.dtype = in[<span class="number">0</span>].type;</span><br><span class="line">    mParams.channelSize = in[<span class="number">0</span>].dims.d[<span class="number">0</span>];</span><br><span class="line">    mParams.height = in[<span class="number">0</span>].dims.d[<span class="number">1</span>];</span><br><span class="line">    mParams.width = in[<span class="number">0</span>].dims.d[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mParams.dtype == nvinfer1::DataType::kINT8)</span><br><span class="line">    &#123;</span><br><span class="line">        mParams.dtypeBytes = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mParams.dtype == nvinfer1::DataType::kHALF)</span><br><span class="line">    &#123;</span><br><span class="line">        mParams.dtypeBytes = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mParams.dtype == nvinfer1::DataType::kFLOAT)</span><br><span class="line">    &#123;</span><br><span class="line">        mParams.dtypeBytes = <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">PLUGIN_ASSERT</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">IdentityConv::initialize</span><span class="params">()</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// The configuration is known at this time, and the inference engine is</span></span><br><span class="line">    <span class="comment">// being created, so the plugin can set up its internal data structures and</span></span><br><span class="line">    <span class="comment">// prepare for execution. Such setup might include initializing libraries,</span></span><br><span class="line">    <span class="comment">// allocating memory, etc. In our case, we don&#x27;t need to prepare anything.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IdentityConv::terminate</span><span class="params">()</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// The engine context is destroyed, and all the resources held by the plugin</span></span><br><span class="line">    <span class="comment">// must be released.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">nvinfer1::Dims <span class="title">IdentityConv::getOutputDimensions</span><span class="params">(<span class="type">int32_t</span> index,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                 nvinfer1::Dims <span class="type">const</span>* inputs,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                 <span class="type">int32_t</span> nbInputDims)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Even though non-IPluginV2DynamicExt plugins are compatible with explicit</span></span><br><span class="line">    <span class="comment">// batch mode networks, their implementation must be independent of the type</span></span><br><span class="line">    <span class="comment">// of network (implicit/explicit batch mode) in which it is expected to be</span></span><br><span class="line">    <span class="comment">// used. As such, when using such plugins in explicit batch mode networks:</span></span><br><span class="line">    <span class="comment">// * The leading dimension of the first input (before being passed to the</span></span><br><span class="line">    <span class="comment">// plugin) is inferred to be the batch dimension.</span></span><br><span class="line">    <span class="comment">// * TensorRT pops this first dimension identified above before inputs are</span></span><br><span class="line">    <span class="comment">// passed to the plugin, and pushes it to the front of any outputs emitted</span></span><br><span class="line">    <span class="comment">// by the plugin. This means that the batch dimension must not be specified</span></span><br><span class="line">    <span class="comment">// in getOutputDimensions.</span></span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(index == <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(nbInputDims == <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(inputs != <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="comment">// CHW</span></span><br><span class="line">    nvinfer1::Dims dimsOutput;</span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(inputs[<span class="number">0</span>].nbDims == <span class="number">3</span>);</span><br><span class="line">    <span class="comment">// Identity operation.</span></span><br><span class="line">    <span class="comment">// Just copy the dimensions from the input tensor.</span></span><br><span class="line">    dimsOutput.nbDims = inputs[<span class="number">0</span>].nbDims;</span><br><span class="line">    dimsOutput.d[<span class="number">0</span>] = inputs[<span class="number">0</span>].d[<span class="number">0</span>];</span><br><span class="line">    dimsOutput.d[<span class="number">1</span>] = inputs[<span class="number">0</span>].d[<span class="number">1</span>];</span><br><span class="line">    dimsOutput.d[<span class="number">2</span>] = inputs[<span class="number">0</span>].d[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dimsOutput;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">IdentityConv::getWorkspaceSize</span><span class="params">(<span class="type">int32_t</span> maxBatchSize)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// No scratch space is required for this plugin.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">IdentityConv::getSerializationSize</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// return sizeof(IdentityConvParameters);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sizeof</span>(<span class="type">int32_t</span>) * <span class="number">4</span> + <span class="built_in">sizeof</span>(nvinfer1::DataType) + <span class="built_in">sizeof</span>(<span class="type">size_t</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IdentityConv::serialize</span><span class="params">(<span class="type">void</span>* buffer)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span>* d&#123;<span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(buffer)&#125;;</span><br><span class="line">    <span class="type">char</span>* <span class="type">const</span> a&#123;d&#125;;</span><br><span class="line">    <span class="comment">// Be cautious, the order has to match deserialization.</span></span><br><span class="line">    <span class="built_in">write</span>(d, mParams.group);</span><br><span class="line">    <span class="built_in">write</span>(d, mParams.dtype);</span><br><span class="line">    <span class="built_in">write</span>(d, mParams.channelSize);</span><br><span class="line">    <span class="built_in">write</span>(d, mParams.height);</span><br><span class="line">    <span class="built_in">write</span>(d, mParams.width);</span><br><span class="line">    <span class="built_in">write</span>(d, mParams.dtypeBytes);</span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(d == a + <span class="built_in">getSerializationSize</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">IdentityConv::supportsFormatCombination</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int32_t</span> pos, nvinfer1::PluginTensorDesc <span class="type">const</span>* inOut, <span class="type">int32_t</span> nbInputs,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int32_t</span> nbOutputs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// For this method inputs are numbered 0..(nbInputs-1) and outputs are</span></span><br><span class="line">    <span class="comment">// numbered nbInputs..(nbInputs+nbOutputs-1). Using this numbering, pos is</span></span><br><span class="line">    <span class="comment">// an index into InOut, where 0 &lt;= pos &lt; nbInputs+nbOutputs.</span></span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(nbInputs == <span class="number">2</span> &amp;&amp; nbOutputs == <span class="number">1</span> &amp;&amp;</span><br><span class="line">                  pos &lt; nbInputs + nbOutputs);</span><br><span class="line">    <span class="type">bool</span> isValidCombination = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Suppose we support only a limited number of format configurations.</span></span><br><span class="line">    isValidCombination |=</span><br><span class="line">        (inOut[pos].format == nvinfer1::TensorFormat::kLINEAR &amp;&amp;</span><br><span class="line">         inOut[pos].type == nvinfer1::DataType::kFLOAT);</span><br><span class="line">    isValidCombination |=</span><br><span class="line">        (inOut[pos].format == nvinfer1::TensorFormat::kLINEAR &amp;&amp;</span><br><span class="line">         inOut[pos].type == nvinfer1::DataType::kHALF);</span><br><span class="line">    <span class="comment">// Make sure the input tensor and output tensor types and formats are same.</span></span><br><span class="line">    isValidCombination &amp;=</span><br><span class="line">        (pos &lt; nbInputs || (inOut[pos].format == inOut[<span class="number">0</span>].format &amp;&amp;</span><br><span class="line">                            inOut[pos].type == inOut[<span class="number">0</span>].type));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> isValidCombination;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> <span class="type">const</span>* <span class="title">IdentityConv::getPluginType</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> kIDENTITY_CONV_PLUGIN_NAME;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> <span class="type">const</span>* <span class="title">IdentityConv::getPluginVersion</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> kIDENTITY_CONV_PLUGIN_VERSION;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IdentityConv::destroy</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123; <span class="keyword">delete</span> <span class="keyword">this</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function">nvinfer1::IPluginV2IOExt* <span class="title">IdentityConv::clone</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// It&#x27;s possible to encounter errors during cloning.</span></span><br><span class="line">    <span class="comment">// For example, if the memory to allocate is insufficient, exceptions can be</span></span><br><span class="line">    <span class="comment">// thrown.</span></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        IPluginV2IOExt* <span class="type">const</span> plugin&#123;<span class="keyword">new</span> IdentityConv&#123;mParams&#125;&#125;;</span><br><span class="line">        plugin-&gt;<span class="built_in">setPluginNamespace</span>(mPluginNamespace);</span><br><span class="line">        <span class="keyword">return</span> plugin;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span> (std::exception <span class="type">const</span>&amp; e)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">caughtError</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IdentityConv::setPluginNamespace</span><span class="params">(<span class="type">char</span> <span class="type">const</span>* pluginNamespace)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mPluginNamespace = pluginNamespace;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> <span class="type">const</span>* <span class="title">IdentityConv::getPluginNamespace</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mPluginNamespace;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">nvinfer1::DataType</span></span><br><span class="line"><span class="function"><span class="title">IdentityConv::getOutputDataType</span><span class="params">(<span class="type">int32_t</span> index,</span></span></span><br><span class="line"><span class="params"><span class="function">                                nvinfer1::DataType <span class="type">const</span>* inputTypes,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">int32_t</span> nbInputs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// One output.</span></span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(index == <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">PLUGIN_ASSERT</span>(nbInputs == <span class="number">2</span>);</span><br><span class="line">    <span class="comment">// The output type is the same as the input type.</span></span><br><span class="line">    <span class="keyword">return</span> inputTypes[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">IdentityConv::isOutputBroadcastAcrossBatch</span><span class="params">(<span class="type">int32_t</span> outputIndex,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                <span class="type">bool</span> <span class="type">const</span>* inputIsBroadcasted,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                <span class="type">int32_t</span> nbInputs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">IdentityConv::canBroadcastInputAcrossBatch</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int32_t</span> inputIndex)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">IdentityConv::enqueue</span><span class="params">(<span class="type">int32_t</span> batchSize, <span class="type">void</span> <span class="type">const</span>* <span class="type">const</span>* inputs,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">void</span>* <span class="type">const</span>* outputs, <span class="type">void</span>* workspace,</span></span></span><br><span class="line"><span class="params"><span class="function">                              cudaStream_t stream)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">size_t</span> <span class="type">const</span> inputSize&#123;<span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(batchSize * mParams.channelSize *</span><br><span class="line">                                               mParams.height * mParams.width)&#125;;</span><br><span class="line">    <span class="type">size_t</span> <span class="type">const</span> inputSizeBytes&#123;inputSize * mParams.dtypeBytes&#125;;</span><br><span class="line">    cudaError_t <span class="type">const</span> status&#123;<span class="built_in">cudaMemcpyAsync</span>(outputs[<span class="number">0</span>], inputs[<span class="number">0</span>],</span><br><span class="line">                                             inputSizeBytes,</span><br><span class="line">                                             cudaMemcpyDeviceToDevice, stream)&#125;;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace plugin</span></span><br><span class="line">&#125; <span class="comment">// namespace nvinfer1</span></span><br></pre></td></tr></table></figure>

<p>In the above implementation, some of the other caveats, such as how to specify the supported custom plugin configurations, what and how to serialize and deserialize the plugin parameters, have also been demonstrated.</p>
<h2 id="IdentityConv-Custom-Plugin-Creator-Implementation"><a href="#IdentityConv-Custom-Plugin-Creator-Implementation" class="headerlink" title="IdentityConv Custom Plugin Creator Implementation"></a>IdentityConv Custom Plugin Creator Implementation</h2><p>TensorRT will call the <code>nvinfer1::IPluginCreator::createPlugin</code> method to create the custom plugin instance. Therefore, we have to create a custom plugin creator class that is derived from the <code>nvinfer1::IPluginCreator</code> class.</p>
<figure class="highlight c++"><figcaption><span>IdentityConvPluginCreator.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> TENSORRT_IDENTITY_CONV_PLUGIN_CREATOR_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TENSORRT_IDENTITY_CONV_PLUGIN_CREATOR_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;NvInferRuntime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> nvinfer1</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">namespace</span> plugin</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseCreator</span> : <span class="keyword">public</span> nvinfer1::IPluginCreator</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setPluginNamespace</span><span class="params">(<span class="type">char</span> <span class="type">const</span>* libNamespace)</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        mNamespace = libNamespace;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="type">const</span>* <span class="title">getPluginNamespace</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mNamespace.<span class="built_in">c_str</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    std::string mNamespace;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Plugin factory class.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IdentityConvCreator</span> : <span class="keyword">public</span> BaseCreator</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">IdentityConvCreator</span>();</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">IdentityConvCreator</span>() <span class="keyword">override</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="type">const</span>* <span class="title">getPluginName</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="type">const</span>* <span class="title">getPluginVersion</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">nvinfer1::PluginFieldCollection <span class="type">const</span>* <span class="title">getFieldNames</span><span class="params">()</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">nvinfer1::IPluginV2IOExt*</span></span><br><span class="line"><span class="function">    <span class="title">createPlugin</span><span class="params">(<span class="type">char</span> <span class="type">const</span>* name,</span></span></span><br><span class="line"><span class="params"><span class="function">                 nvinfer1::PluginFieldCollection <span class="type">const</span>* fc)</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">nvinfer1::IPluginV2IOExt*</span></span><br><span class="line"><span class="function">    <span class="title">deserializePlugin</span><span class="params">(<span class="type">char</span> <span class="type">const</span>* name, <span class="type">void</span> <span class="type">const</span>* serialData,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">size_t</span> serialLength)</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    nvinfer1::PluginFieldCollection mFC;</span><br><span class="line">    std::vector&lt;nvinfer1::PluginField&gt; mPluginAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    std::string mNamespace;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace plugin</span></span><br><span class="line">&#125; <span class="comment">// namespace nvinfer1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// TENSORRT_IDENTITY_CONV_PLUGIN_CREATOR_H</span></span></span><br></pre></td></tr></table></figure>

<p>TensorRT allows both static and dynamic registration of custom plugins. The <code>REGISTER_TENSORRT_PLUGIN</code> macro is used to register the custom plugin creator class. In this example, we use the dynamic registration method. Therefore, the <code>REGISTER_TENSORRT_PLUGIN</code> macro is commented out.</p>
<figure class="highlight c++"><figcaption><span>IdentityConvPluginCreator.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;exception&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;NvInferRuntimePlugin.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;IdentityConvPlugin.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;IdentityConvPluginCreator.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;PluginUtils.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> nvinfer1</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">namespace</span> plugin</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is not needed for plugin dynamic registration.</span></span><br><span class="line"><span class="comment">// REGISTER_TENSORRT_PLUGIN(IdentityConvCreator);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Plugin creator</span></span><br><span class="line">IdentityConvCreator::<span class="built_in">IdentityConvCreator</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Declare the ONNX attributes that the ONNX parser will collect from the</span></span><br><span class="line">    <span class="comment">// ONNX model that contains the IdentityConv node.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// In our dummy case,</span></span><br><span class="line">    <span class="comment">// attrs=&#123;</span></span><br><span class="line">    <span class="comment">//     &quot;kernel_shape&quot;: [1, 1],</span></span><br><span class="line">    <span class="comment">//     &quot;strides&quot;: [1, 1],</span></span><br><span class="line">    <span class="comment">//     &quot;pads&quot;: [0, 0, 0, 0],</span></span><br><span class="line">    <span class="comment">//     &quot;group&quot;: num_groups</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    mPluginAttributes.<span class="built_in">clear</span>();</span><br><span class="line">    mPluginAttributes.<span class="built_in">emplace_back</span>(nvinfer1::<span class="built_in">PluginField</span>(</span><br><span class="line">        <span class="string">&quot;kernel_shape&quot;</span>, <span class="literal">nullptr</span>, PluginFieldType::kINT32, <span class="number">2</span>));</span><br><span class="line">    mPluginAttributes.<span class="built_in">emplace_back</span>(</span><br><span class="line">        nvinfer1::<span class="built_in">PluginField</span>(<span class="string">&quot;strides&quot;</span>, <span class="literal">nullptr</span>, PluginFieldType::kINT32, <span class="number">2</span>));</span><br><span class="line">    mPluginAttributes.<span class="built_in">emplace_back</span>(</span><br><span class="line">        nvinfer1::<span class="built_in">PluginField</span>(<span class="string">&quot;pads&quot;</span>, <span class="literal">nullptr</span>, PluginFieldType::kINT32, <span class="number">4</span>));</span><br><span class="line">    mPluginAttributes.<span class="built_in">emplace_back</span>(</span><br><span class="line">        nvinfer1::<span class="built_in">PluginField</span>(<span class="string">&quot;group&quot;</span>, <span class="literal">nullptr</span>, PluginFieldType::kINT32, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    mFC.nbFields = mPluginAttributes.<span class="built_in">size</span>();</span><br><span class="line">    mFC.fields = mPluginAttributes.<span class="built_in">data</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> <span class="type">const</span>* <span class="title">IdentityConvCreator::getPluginName</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> kIDENTITY_CONV_PLUGIN_NAME;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> <span class="type">const</span>* <span class="title">IdentityConvCreator::getPluginVersion</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> kIDENTITY_CONV_PLUGIN_VERSION;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">nvinfer1::PluginFieldCollection <span class="type">const</span>*</span></span><br><span class="line"><span class="function"><span class="title">IdentityConvCreator::getFieldNames</span><span class="params">()</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;mFC;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">nvinfer1::IPluginV2IOExt* <span class="title">IdentityConvCreator::createPlugin</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">char</span> <span class="type">const</span>* name, nvinfer1::PluginFieldCollection <span class="type">const</span>* fc)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// The attributes from the ONNX node will be parsed and passed via fc.</span></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        nvinfer1::PluginField <span class="type">const</span>* fields&#123;fc-&gt;fields&#125;;</span><br><span class="line">        <span class="type">int32_t</span> nbFields&#123;fc-&gt;nbFields&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">PLUGIN_VALIDATE</span>(nbFields == <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="type">int32_t</span>&gt; kernelShape&#123;&#125;;</span><br><span class="line">        std::vector&lt;<span class="type">int32_t</span>&gt; strides&#123;&#125;;</span><br><span class="line">        std::vector&lt;<span class="type">int32_t</span>&gt; pads&#123;&#125;;</span><br><span class="line">        <span class="type">int32_t</span> group&#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int32_t</span> i&#123;<span class="number">0</span>&#125;; i &lt; nbFields; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">char</span> <span class="type">const</span>* attrName = fields[i].name;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(attrName, <span class="string">&quot;kernel_shape&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">PLUGIN_VALIDATE</span>(fields[i].type ==</span><br><span class="line">                                nvinfer1::PluginFieldType::kINT32);</span><br><span class="line">                <span class="type">int32_t</span> <span class="type">const</span>* <span class="type">const</span> kernelShapeData&#123;</span><br><span class="line">                    <span class="built_in">static_cast</span>&lt;<span class="type">int32_t</span> <span class="type">const</span>*&gt;(fields[i].data)&#125;;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int32_t</span> j&#123;<span class="number">0</span>&#125;; j &lt; fields[i].length; ++j)</span><br><span class="line">                &#123;</span><br><span class="line">                    kernelShape.<span class="built_in">push_back</span>(kernelShapeData[j]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(attrName, <span class="string">&quot;strides&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">PLUGIN_VALIDATE</span>(fields[i].type ==</span><br><span class="line">                                nvinfer1::PluginFieldType::kINT32);</span><br><span class="line">                <span class="type">int32_t</span> <span class="type">const</span>* <span class="type">const</span> stridesData&#123;</span><br><span class="line">                    <span class="built_in">static_cast</span>&lt;<span class="type">int32_t</span> <span class="type">const</span>*&gt;(fields[i].data)&#125;;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int32_t</span> j&#123;<span class="number">0</span>&#125;; j &lt; fields[i].length; ++j)</span><br><span class="line">                &#123;</span><br><span class="line">                    strides.<span class="built_in">push_back</span>(stridesData[j]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(attrName, <span class="string">&quot;pads&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">PLUGIN_VALIDATE</span>(fields[i].type ==</span><br><span class="line">                                nvinfer1::PluginFieldType::kINT32);</span><br><span class="line">                <span class="type">int32_t</span> <span class="type">const</span>* <span class="type">const</span> padsData&#123;</span><br><span class="line">                    <span class="built_in">static_cast</span>&lt;<span class="type">int32_t</span> <span class="type">const</span>*&gt;(fields[i].data)&#125;;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int32_t</span> j&#123;<span class="number">0</span>&#125;; j &lt; fields[i].length; ++j)</span><br><span class="line">                &#123;</span><br><span class="line">                    pads.<span class="built_in">push_back</span>(padsData[j]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(attrName, <span class="string">&quot;group&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">PLUGIN_VALIDATE</span>(fields[i].type ==</span><br><span class="line">                                nvinfer1::PluginFieldType::kINT32);</span><br><span class="line">                <span class="built_in">PLUGIN_VALIDATE</span>(fields[i].length == <span class="number">1</span>);</span><br><span class="line">                group = *(<span class="built_in">static_cast</span>&lt;<span class="type">int32_t</span> <span class="type">const</span>*&gt;(fields[i].data));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Log the attributes parsed from ONNX node.</span></span><br><span class="line">        std::stringstream ss;</span><br><span class="line">        ss &lt;&lt; <span class="string">&quot;Plugin Attributes:&quot;</span>;</span><br><span class="line">        <span class="built_in">logInfo</span>(ss.<span class="built_in">str</span>().<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">        ss.<span class="built_in">str</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        ss &lt;&lt; <span class="string">&quot;kernel_shape: &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> <span class="type">const</span>&amp; val : kernelShape)</span><br><span class="line">        &#123;</span><br><span class="line">            ss &lt;&lt; val &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">logInfo</span>(ss.<span class="built_in">str</span>().<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">        ss.<span class="built_in">str</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        ss &lt;&lt; <span class="string">&quot;strides: &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> <span class="type">const</span>&amp; val : strides)</span><br><span class="line">        &#123;</span><br><span class="line">            ss &lt;&lt; val &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">logInfo</span>(ss.<span class="built_in">str</span>().<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">        ss.<span class="built_in">str</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        ss &lt;&lt; <span class="string">&quot;pads: &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> <span class="type">const</span>&amp; val : pads)</span><br><span class="line">        &#123;</span><br><span class="line">            ss &lt;&lt; val &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">logInfo</span>(ss.<span class="built_in">str</span>().<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">        ss.<span class="built_in">str</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        ss &lt;&lt; <span class="string">&quot;group: &quot;</span> &lt;&lt; group;</span><br><span class="line">        <span class="built_in">logInfo</span>(ss.<span class="built_in">str</span>().<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">        IdentityConvParameters <span class="type">const</span> params&#123;.group = group&#125;;</span><br><span class="line"></span><br><span class="line">        IdentityConv* <span class="type">const</span> plugin&#123;<span class="keyword">new</span> IdentityConv&#123;params&#125;&#125;;</span><br><span class="line">        plugin-&gt;<span class="built_in">setPluginNamespace</span>(mNamespace.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="keyword">return</span> plugin;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span> (std::exception <span class="type">const</span>&amp; e)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">caughtError</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">nvinfer1::IPluginV2IOExt*</span></span><br><span class="line"><span class="function"><span class="title">IdentityConvCreator::deserializePlugin</span><span class="params">(<span class="type">char</span> <span class="type">const</span>* name, <span class="type">void</span> <span class="type">const</span>* serialData,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       <span class="type">size_t</span> serialLength)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        IdentityConv* plugin = <span class="keyword">new</span> IdentityConv&#123;serialData, serialLength&#125;;</span><br><span class="line">        plugin-&gt;<span class="built_in">setPluginNamespace</span>(mNamespace.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="keyword">return</span> plugin;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span> (std::exception <span class="type">const</span>&amp; e)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">caughtError</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace plugin</span></span><br><span class="line">&#125; <span class="comment">// namespace nvinfer1</span></span><br></pre></td></tr></table></figure>

<p>In the above implementation, some of the other caveats, such as how to rely on the TensorRT ONNX parser to parse the attributes of the custom ONNX node, have also been demonstrated.</p>
<h2 id="Expose-IdentityConv-Custom-Plugin-Creator-to-TensorRT"><a href="#Expose-IdentityConv-Custom-Plugin-Creator-to-TensorRT" class="headerlink" title="Expose IdentityConv Custom Plugin Creator to TensorRT"></a>Expose IdentityConv Custom Plugin Creator to TensorRT</h2><p>Because the custom plugin library will be loaded dynamically by TensorRT, we have to expose the plugin creator class to TensorRT from the dynamic library. The <code>setLoggerFinder</code> and <code>getPluginCreators</code> functions are mandatory to implement so that TensorRT can call them successfully during the plugin creation time.</p>
<figure class="highlight c++"><figcaption><span>PluginRegistration.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> TENSORRT_PLUGIN_REGISTRATION_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TENSORRT_PLUGIN_REGISTRATION_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;NvInferRuntime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// These are the functions that TensorRT library will call at the runtime.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">void</span> <span class="title">setLoggerFinder</span><span class="params">(nvinfer1::ILoggerFinder* finder)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">nvinfer1::IPluginCreator* <span class="type">const</span>*</span></span><br><span class="line"><span class="function"><span class="title">getPluginCreators</span><span class="params">(<span class="type">int32_t</span>&amp; nbCreators)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// TENSORRT_PLUGIN_REGISTRATION_H</span></span></span><br></pre></td></tr></table></figure>

<p>If we have multiple custom plugins, we can register them all in the <code>getPluginCreators</code> function. In this example, we only have one custom plugin.</p>
<figure class="highlight c++"><figcaption><span>PluginRegistration.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;NvInferRuntime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;IdentityConvPluginCreator.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadSafeLoggerFinder</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ThreadSafeLoggerFinder</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the logger finder.</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setLoggerFinder</span><span class="params">(nvinfer1::ILoggerFinder* finder)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lk</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (mLoggerFinder == <span class="literal">nullptr</span> &amp;&amp; finder != <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mLoggerFinder = finder;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the logger.</span></span><br><span class="line">    <span class="function">nvinfer1::ILogger* <span class="title">getLogger</span><span class="params">()</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lk</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (mLoggerFinder != <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mLoggerFinder-&gt;<span class="built_in">findLogger</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    nvinfer1::ILoggerFinder* mLoggerFinder&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">    std::mutex mMutex;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ThreadSafeLoggerFinder gLoggerFinder;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Not exposing this function to the user to get the plugin logger for the</span></span><br><span class="line"><span class="comment">// moment. Can switch the plugin logger to this in the future.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ILogger* getPluginLogger()</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//     return gLoggerFinder.getLogger();</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">void</span> <span class="title">setLoggerFinder</span><span class="params">(nvinfer1::ILoggerFinder* finder)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gLoggerFinder.<span class="built_in">setLoggerFinder</span>(finder);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">nvinfer1::IPluginCreator* <span class="type">const</span>*</span></span><br><span class="line"><span class="function"><span class="title">getPluginCreators</span><span class="params">(<span class="type">int32_t</span>&amp; nbCreators)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    nbCreators = <span class="number">1</span>;</span><br><span class="line">    <span class="type">static</span> nvinfer1::plugin::IdentityConvCreator identityConvCreator&#123;&#125;;</span><br><span class="line">    <span class="type">static</span> nvinfer1::IPluginCreator* <span class="type">const</span> pluginCreatorList[] = &#123;</span><br><span class="line">        &amp;identityConvCreator&#125;;</span><br><span class="line">    <span class="keyword">return</span> pluginCreatorList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Build-Engine-With-Custom-Plugin"><a href="#Build-Engine-With-Custom-Plugin" class="headerlink" title="Build Engine With Custom Plugin"></a>Build Engine With Custom Plugin</h2><p>The custom plugin library can be dynamically registered and loaded by TensorRT via the <code>nvinfer1::IPluginRegistry::loadLibrary</code> method. The ONNX parser can then parse the custom ONNX node and use the custom plugin to run the inference for the custom ONNX node.</p>
<p>The custom plugin can also be serialized into the TensorRT engine file via the <code>nvinfer1::IBuilderConfig::setPluginsToSerialize</code> method so that the custom plugin library is not required to be loaded during the inference time.</p>
<figure class="highlight c++"><figcaption><span>build_engine.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a TensorRT engine building program that builds an engine from an ONNX</span></span><br><span class="line"><span class="comment">// file and uses a custom plugin.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;NvInfer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;NvOnnxParser.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomLogger</span> : <span class="keyword">public</span> nvinfer1::ILogger</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">log</span><span class="params">(nvinfer1::ILogger::Severity severity,</span></span></span><br><span class="line"><span class="params"><span class="function">             <span class="type">const</span> <span class="type">char</span>* msg)</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (severity &lt;= nvinfer1::ILogger::Severity::kINFO)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; msg &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">InferDeleter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(T* obj)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">delete</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CustomLogger logger&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    std::string <span class="type">const</span> data_dir_path&#123;<span class="string">&quot;data&quot;</span>&#125;;</span><br><span class="line">    std::string <span class="type">const</span> onnx_file_name&#123;<span class="string">&quot;identity_neural_network.onnx&quot;</span>&#125;;</span><br><span class="line">    std::string <span class="type">const</span> engine_file_name&#123;<span class="string">&quot;identity_neural_network.engine&quot;</span>&#125;;</span><br><span class="line">    std::string <span class="type">const</span> onnx_file_path&#123;data_dir_path + <span class="string">&quot;/&quot;</span> + onnx_file_name&#125;;</span><br><span class="line">    std::string <span class="type">const</span> engine_file_path&#123;data_dir_path + <span class="string">&quot;/&quot;</span> + engine_file_name&#125;;</span><br><span class="line">    std::string <span class="type">const</span> plugin_library_name&#123;<span class="string">&quot;libidentity_conv.so&quot;</span>&#125;;</span><br><span class="line">    std::string <span class="type">const</span> plugin_library_dir_path&#123;<span class="string">&quot;build/src&quot;</span>&#125;;</span><br><span class="line">    std::string <span class="type">const</span> plugin_library_path&#123;plugin_library_dir_path + <span class="string">&quot;/&quot;</span> +</span><br><span class="line">                                          plugin_library_name&#125;;</span><br><span class="line">    <span class="type">char</span> <span class="type">const</span>* <span class="type">const</span> plugin_library_path_c_str&#123;plugin_library_path.<span class="built_in">c_str</span>()&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the builder.</span></span><br><span class="line">    std::unique_ptr&lt;nvinfer1::IBuilder, InferDeleter&gt; builder&#123;</span><br><span class="line">        nvinfer1::<span class="built_in">createInferBuilder</span>(logger)&#125;;</span><br><span class="line">    <span class="keyword">if</span> (builder == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to create the builder.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">void</span>* <span class="type">const</span> plugin_handle&#123;</span><br><span class="line">        builder-&gt;<span class="built_in">getPluginRegistry</span>().<span class="built_in">loadLibrary</span>(plugin_library_path.<span class="built_in">c_str</span>())&#125;;</span><br><span class="line">    <span class="keyword">if</span> (plugin_handle == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to load the plugin library.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the network.</span></span><br><span class="line">    <span class="type">uint32_t</span> <span class="type">const</span> flag&#123;</span><br><span class="line">        <span class="number">1U</span> &lt;&lt; <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(</span><br><span class="line">            nvinfer1::NetworkDefinitionCreationFlag::kEXPLICIT_BATCH)&#125;;</span><br><span class="line">    std::unique_ptr&lt;nvinfer1::INetworkDefinition, InferDeleter&gt; network&#123;</span><br><span class="line">        builder-&gt;<span class="built_in">createNetworkV2</span>(flag)&#125;;</span><br><span class="line">    <span class="keyword">if</span> (network == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to create the network.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the parser.</span></span><br><span class="line">    std::unique_ptr&lt;nvonnxparser::IParser, InferDeleter&gt; parser&#123;</span><br><span class="line">        nvonnxparser::<span class="built_in">createParser</span>(*network, logger)&#125;;</span><br><span class="line">    <span class="keyword">if</span> (parser == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to create the parser.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    parser-&gt;<span class="built_in">parseFromFile</span>(</span><br><span class="line">        onnx_file_path.<span class="built_in">c_str</span>(),</span><br><span class="line">        <span class="built_in">static_cast</span>&lt;<span class="type">int32_t</span>&gt;(nvinfer1::ILogger::Severity::kWARNING));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int32_t</span> i = <span class="number">0</span>; i &lt; parser-&gt;<span class="built_in">getNbErrors</span>(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; parser-&gt;<span class="built_in">getError</span>(i)-&gt;<span class="built_in">desc</span>() &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the allowed IO tensor formats.</span></span><br><span class="line">    <span class="type">uint32_t</span> <span class="type">const</span> formats&#123;</span><br><span class="line">        <span class="number">1U</span> &lt;&lt; <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(nvinfer1::TensorFormat::kLINEAR)&#125;;</span><br><span class="line">    nvinfer1::DataType <span class="type">const</span> dtype&#123;nvinfer1::DataType::kFLOAT&#125;;</span><br><span class="line">    network-&gt;<span class="built_in">getInput</span>(<span class="number">0</span>)-&gt;<span class="built_in">setAllowedFormats</span>(formats);</span><br><span class="line">    network-&gt;<span class="built_in">getInput</span>(<span class="number">0</span>)-&gt;<span class="built_in">setType</span>(dtype);</span><br><span class="line">    network-&gt;<span class="built_in">getOutput</span>(<span class="number">0</span>)-&gt;<span class="built_in">setAllowedFormats</span>(formats);</span><br><span class="line">    network-&gt;<span class="built_in">getOutput</span>(<span class="number">0</span>)-&gt;<span class="built_in">setType</span>(dtype);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Build the engine.</span></span><br><span class="line">    std::unique_ptr&lt;nvinfer1::IBuilderConfig, InferDeleter&gt; config&#123;</span><br><span class="line">        builder-&gt;<span class="built_in">createBuilderConfig</span>()&#125;;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to create the builder config.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    config-&gt;<span class="built_in">setMemoryPoolLimit</span>(nvinfer1::MemoryPoolType::kWORKSPACE, <span class="number">1U</span> &lt;&lt; <span class="number">20</span>);</span><br><span class="line">    config-&gt;<span class="built_in">setFlag</span>(nvinfer1::BuilderFlag::kFP16);</span><br><span class="line">    config-&gt;<span class="built_in">setPluginsToSerialize</span>(&amp;plugin_library_path_c_str, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    std::unique_ptr&lt;nvinfer1::IHostMemory, InferDeleter&gt; serializedModel&#123;</span><br><span class="line">        builder-&gt;<span class="built_in">buildSerializedNetwork</span>(*network, *config)&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write the serialized engine to a file.</span></span><br><span class="line">    std::ofstream engineFile&#123;engine_file_path.<span class="built_in">c_str</span>(), std::ios::binary&#125;;</span><br><span class="line">    <span class="keyword">if</span> (!engineFile.<span class="built_in">is_open</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to open the engine file.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    engineFile.<span class="built_in">write</span>(<span class="built_in">static_cast</span>&lt;<span class="type">char</span> <span class="type">const</span>*&gt;(serializedModel-&gt;<span class="built_in">data</span>()),</span><br><span class="line">                     serializedModel-&gt;<span class="built_in">size</span>());</span><br><span class="line">    engineFile.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Successfully serialized the engine to the file: &quot;</span></span><br><span class="line">              &lt;&lt; engine_file_path &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Run-Engine-With-Custom-Plugin"><a href="#Run-Engine-With-Custom-Plugin" class="headerlink" title="Run Engine With Custom Plugin"></a>Run Engine With Custom Plugin</h2><p>Because the custom plugin has been serialized into the TensorRT engine file, we don’t need to load the custom plugin library during the inference time. We can simply create the runtime and deserialize the engine from the engine file.</p>
<figure class="highlight c++"><figcaption><span>run_engine.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;random&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;NvInfer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHECK_CUDA_ERROR(val) check((val), #val, __FILE__, __LINE__)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">check</span><span class="params">(cudaError_t err, <span class="type">const</span> <span class="type">char</span>* <span class="type">const</span> func, <span class="type">const</span> <span class="type">char</span>* <span class="type">const</span> file,</span></span></span><br><span class="line"><span class="params"><span class="function">           <span class="type">const</span> <span class="type">int</span> line)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err != cudaSuccess)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;CUDA Runtime Error at: &quot;</span> &lt;&lt; file &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; line</span><br><span class="line">                  &lt;&lt; std::endl;</span><br><span class="line">        std::cerr &lt;&lt; <span class="built_in">cudaGetErrorString</span>(err) &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; func &lt;&lt; std::endl;</span><br><span class="line">        std::<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHECK_LAST_CUDA_ERROR() check_last(__FILE__, __LINE__)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">check_last</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* <span class="type">const</span> file, <span class="type">const</span> <span class="type">int</span> line)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cudaError_t <span class="type">const</span> err&#123;<span class="built_in">cudaGetLastError</span>()&#125;;</span><br><span class="line">    <span class="keyword">if</span> (err != cudaSuccess)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;CUDA Runtime Error at: &quot;</span> &lt;&lt; file &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; line</span><br><span class="line">                  &lt;&lt; std::endl;</span><br><span class="line">        std::cerr &lt;&lt; <span class="built_in">cudaGetErrorString</span>(err) &lt;&lt; std::endl;</span><br><span class="line">        std::<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomLogger</span> : <span class="keyword">public</span> nvinfer1::ILogger</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">log</span><span class="params">(nvinfer1::ILogger::Severity severity,</span></span></span><br><span class="line"><span class="params"><span class="function">             <span class="type">const</span> <span class="type">char</span>* msg)</span> <span class="keyword">noexcept</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// suppress info-level messages</span></span><br><span class="line">        <span class="keyword">if</span> (severity &lt;= nvinfer1::ILogger::Severity::kINFO)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; msg &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">InferDeleter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(T* obj)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">delete</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">create_random_data</span><span class="params">(<span class="type">float</span>* data, <span class="type">size_t</span> <span class="type">const</span> size, <span class="type">unsigned</span> <span class="type">int</span> seed = <span class="number">1U</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::default_random_engine <span class="title">eng</span><span class="params">(seed)</span></span>;</span><br><span class="line">    <span class="function">std::uniform_int_distribution&lt;<span class="type">int32_t</span>&gt; <span class="title">dis</span><span class="params">(<span class="number">-16</span>, <span class="number">16</span>)</span></span>;</span><br><span class="line">    <span class="keyword">auto</span> <span class="type">const</span> rand = [&amp;dis, &amp;eng]() &#123; <span class="keyword">return</span> <span class="built_in">dis</span>(eng); &#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; size; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        data[i] = <span class="built_in">static_cast</span>&lt;<span class="type">float</span>&gt;(<span class="built_in">rand</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">all_close</span><span class="params">(<span class="type">float</span> <span class="type">const</span>* a, <span class="type">float</span> <span class="type">const</span>* b, <span class="type">size_t</span> size, <span class="type">float</span> rtol = <span class="number">1e-5</span>f,</span></span></span><br><span class="line"><span class="params"><span class="function">               <span class="type">float</span> atol = <span class="number">1e-8</span>f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; size; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">float</span> <span class="type">const</span> diff&#123;std::<span class="built_in">abs</span>(a[i] - b[i])&#125;;</span><br><span class="line">        <span class="keyword">if</span> (diff &gt; (atol + rtol * std::<span class="built_in">abs</span>(b[i])))</span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;a[&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;]: &quot;</span> &lt;&lt; a[i] &lt;&lt; std::endl;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;b[&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;]: &quot;</span> &lt;&lt; b[i] &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CustomLogger logger&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The plugin has already been serialized with the engine.</span></span><br><span class="line">    <span class="comment">// There is no need to load the plugin library.</span></span><br><span class="line">    std::string <span class="type">const</span> data_dir_path&#123;<span class="string">&quot;data&quot;</span>&#125;;</span><br><span class="line">    std::string <span class="type">const</span> engine_file_name&#123;<span class="string">&quot;identity_neural_network.engine&quot;</span>&#125;;</span><br><span class="line">    std::string <span class="type">const</span> engine_file_path&#123;data_dir_path + <span class="string">&quot;/&quot;</span> + engine_file_name&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create CUDA stream.</span></span><br><span class="line">    cudaStream_t stream;</span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaStreamCreate</span>(&amp;stream));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The engine we built is FP32 NCHW IO.</span></span><br><span class="line">    nvinfer1::DataType <span class="type">const</span> expected_dtype&#123;nvinfer1::DataType::kFLOAT&#125;;</span><br><span class="line">    <span class="type">size_t</span> <span class="type">const</span> expected_dtype_byte_size&#123;<span class="number">4U</span>&#125;;</span><br><span class="line">    nvinfer1::TensorFormat <span class="type">const</span> expected_format&#123;</span><br><span class="line">        nvinfer1::TensorFormat::kLINEAR&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// IO tensor information and buffers.</span></span><br><span class="line">    std::vector&lt;nvinfer1::Dims&gt; input_tensor_shapes&#123;&#125;;</span><br><span class="line">    std::vector&lt;nvinfer1::Dims&gt; output_tensor_shapes&#123;&#125;;</span><br><span class="line">    std::vector&lt;<span class="type">size_t</span>&gt; input_tensor_sizes&#123;&#125;;</span><br><span class="line">    std::vector&lt;<span class="type">size_t</span>&gt; output_tensor_sizes&#123;&#125;;</span><br><span class="line">    std::vector&lt;<span class="type">char</span> <span class="type">const</span>*&gt; input_tensor_names&#123;&#125;;</span><br><span class="line">    std::vector&lt;<span class="type">char</span> <span class="type">const</span>*&gt; output_tensor_names&#123;&#125;;</span><br><span class="line">    std::vector&lt;<span class="type">void</span>*&gt; input_tensor_host_buffers&#123;&#125;;</span><br><span class="line">    std::vector&lt;<span class="type">void</span>*&gt; input_tensor_device_buffers&#123;&#125;;</span><br><span class="line">    std::vector&lt;<span class="type">void</span>*&gt; output_tensor_host_buffers&#123;&#125;;</span><br><span class="line">    std::vector&lt;<span class="type">void</span>*&gt; output_tensor_device_buffers&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Error tolerance for unit test.</span></span><br><span class="line">    <span class="type">float</span> <span class="type">const</span> rtol&#123;<span class="number">1e-5</span>f&#125;;</span><br><span class="line">    <span class="type">float</span> <span class="type">const</span> atol&#123;<span class="number">1e-8</span>f&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Deserialize the engine.</span></span><br><span class="line">    std::unique_ptr&lt;nvinfer1::IRuntime, InferDeleter&gt; runtime&#123;</span><br><span class="line">        nvinfer1::<span class="built_in">createInferRuntime</span>(logger)&#125;;</span><br><span class="line">    <span class="keyword">if</span> (runtime == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to create the runtime.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::ifstream engine_file&#123;engine_file_path, std::ios::binary&#125;;</span><br><span class="line">    <span class="keyword">if</span> (!engine_file)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to open the engine file.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    engine_file.<span class="built_in">seekg</span>(<span class="number">0</span>, std::ios::end);</span><br><span class="line">    <span class="type">size_t</span> <span class="type">const</span> engine_file_size&#123;<span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(engine_file.<span class="built_in">tellg</span>())&#125;;</span><br><span class="line">    engine_file.<span class="built_in">seekg</span>(<span class="number">0</span>, std::ios::beg);</span><br><span class="line"></span><br><span class="line">    std::unique_ptr&lt;<span class="type">char</span>[]&gt; engine_data&#123;<span class="keyword">new</span> <span class="type">char</span>[engine_file_size]&#125;;</span><br><span class="line">    engine_file.<span class="built_in">read</span>(engine_data.<span class="built_in">get</span>(), engine_file_size);</span><br><span class="line"></span><br><span class="line">    std::unique_ptr&lt;nvinfer1::ICudaEngine, InferDeleter&gt; engine&#123;</span><br><span class="line">        runtime-&gt;<span class="built_in">deserializeCudaEngine</span>(engine_data.<span class="built_in">get</span>(), engine_file_size)&#125;;</span><br><span class="line">    <span class="keyword">if</span> (engine == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to deserialize the engine.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the execution context.</span></span><br><span class="line">    std::unique_ptr&lt;nvinfer1::IExecutionContext, InferDeleter&gt; context&#123;</span><br><span class="line">        engine-&gt;<span class="built_in">createExecutionContext</span>()&#125;;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to create the execution context.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check the number of IO tensors.</span></span><br><span class="line">    <span class="type">int32_t</span> <span class="type">const</span> num_io_tensors&#123;engine-&gt;<span class="built_in">getNbIOTensors</span>()&#125;;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Number of IO Tensors: &quot;</span> &lt;&lt; num_io_tensors &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int32_t</span> i&#123;<span class="number">0</span>&#125;; i &lt; num_io_tensors; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> <span class="type">const</span>* <span class="type">const</span> tensor_name&#123;engine-&gt;<span class="built_in">getIOTensorName</span>(i)&#125;;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Tensor name: &quot;</span> &lt;&lt; tensor_name &lt;&lt; std::endl;</span><br><span class="line">        nvinfer1::TensorIOMode <span class="type">const</span> io_mode&#123;</span><br><span class="line">            engine-&gt;<span class="built_in">getTensorIOMode</span>(tensor_name)&#125;;</span><br><span class="line">        nvinfer1::DataType <span class="type">const</span> dtype&#123;engine-&gt;<span class="built_in">getTensorDataType</span>(tensor_name)&#125;;</span><br><span class="line">        <span class="keyword">if</span> (dtype != expected_dtype)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;Invalid data type.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        nvinfer1::TensorFormat <span class="type">const</span> format&#123;</span><br><span class="line">            engine-&gt;<span class="built_in">getTensorFormat</span>(tensor_name)&#125;;</span><br><span class="line">        <span class="keyword">if</span> (format != expected_format)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;Invalid tensor format.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Because the input and output shapes are static,</span></span><br><span class="line">        <span class="comment">// there is no need to set the IO tensor shapes.</span></span><br><span class="line">        nvinfer1::Dims <span class="type">const</span> shape&#123;engine-&gt;<span class="built_in">getTensorShape</span>(tensor_name)&#125;;</span><br><span class="line">        <span class="comment">// Print out dims.</span></span><br><span class="line">        <span class="type">size_t</span> tensor_size&#123;<span class="number">1U</span>&#125;;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Tensor Dims: &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int32_t</span> j&#123;<span class="number">0</span>&#125;; j &lt; shape.nbDims; ++j)</span><br><span class="line">        &#123;</span><br><span class="line">            tensor_size *= shape.d[j];</span><br><span class="line">            std::cout &lt;&lt; shape.d[j] &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// FP32 NCHW tensor format.</span></span><br><span class="line">        <span class="type">size_t</span> tensor_size_bytes&#123;tensor_size * expected_dtype_byte_size&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Allocate host memory for the tensor.</span></span><br><span class="line">        <span class="type">void</span>* tensor_host_buffer&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">        <span class="built_in">CHECK_CUDA_ERROR</span>(</span><br><span class="line">            <span class="built_in">cudaMallocHost</span>(&amp;tensor_host_buffer, tensor_size_bytes));</span><br><span class="line">        <span class="comment">// Allocate device memory for the tensor.</span></span><br><span class="line">        <span class="type">void</span>* tensor_device_buffer&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">        <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaMalloc</span>(&amp;tensor_device_buffer, tensor_size_bytes));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (io_mode == nvinfer1::TensorIOMode::kINPUT)</span><br><span class="line">        &#123;</span><br><span class="line">            input_tensor_host_buffers.<span class="built_in">push_back</span>(tensor_host_buffer);</span><br><span class="line">            input_tensor_device_buffers.<span class="built_in">push_back</span>(tensor_device_buffer);</span><br><span class="line">            input_tensor_shapes.<span class="built_in">push_back</span>(shape);</span><br><span class="line">            input_tensor_sizes.<span class="built_in">push_back</span>(tensor_size);</span><br><span class="line">            input_tensor_names.<span class="built_in">push_back</span>(tensor_name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            output_tensor_host_buffers.<span class="built_in">push_back</span>(tensor_host_buffer);</span><br><span class="line">            output_tensor_device_buffers.<span class="built_in">push_back</span>(tensor_device_buffer);</span><br><span class="line">            output_tensor_shapes.<span class="built_in">push_back</span>(shape);</span><br><span class="line">            output_tensor_sizes.<span class="built_in">push_back</span>(tensor_size);</span><br><span class="line">            output_tensor_names.<span class="built_in">push_back</span>(tensor_name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create random input values.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; input_tensor_host_buffers.<span class="built_in">size</span>(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">size_t</span> <span class="type">const</span> tensor_size&#123;input_tensor_sizes.<span class="built_in">at</span>(i)&#125;;</span><br><span class="line">        <span class="built_in">create_random_data</span>(<span class="built_in">static_cast</span>&lt;<span class="type">float</span>*&gt;(input_tensor_host_buffers.<span class="built_in">at</span>(i)),</span><br><span class="line">                           tensor_size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copy input data from host to device.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; input_tensor_host_buffers.<span class="built_in">size</span>(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">size_t</span> <span class="type">const</span> tensor_size_bytes&#123;input_tensor_sizes.<span class="built_in">at</span>(i) *</span><br><span class="line">                                       expected_dtype_byte_size&#125;;</span><br><span class="line">        <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaMemcpy</span>(input_tensor_device_buffers.<span class="built_in">at</span>(i),</span><br><span class="line">                                    input_tensor_host_buffers.<span class="built_in">at</span>(i),</span><br><span class="line">                                    tensor_size_bytes, cudaMemcpyHostToDevice));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bind IO tensor buffers to the execution context.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; input_tensor_device_buffers.<span class="built_in">size</span>(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> <span class="type">const</span>* <span class="type">const</span> tensor_name&#123;input_tensor_names.<span class="built_in">at</span>(i)&#125;;</span><br><span class="line">        context-&gt;<span class="built_in">setTensorAddress</span>(tensor_name,</span><br><span class="line">                                  input_tensor_device_buffers.<span class="built_in">at</span>(i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; output_tensor_device_buffers.<span class="built_in">size</span>(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> <span class="type">const</span>* <span class="type">const</span> tensor_name&#123;output_tensor_names.<span class="built_in">at</span>(i)&#125;;</span><br><span class="line">        context-&gt;<span class="built_in">setTensorAddress</span>(tensor_name,</span><br><span class="line">                                  output_tensor_device_buffers.<span class="built_in">at</span>(i));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Run inference a couple of times.</span></span><br><span class="line">    <span class="type">size_t</span> <span class="type">const</span> num_iterations&#123;<span class="number">8U</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; num_iterations; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">bool</span> <span class="type">const</span> status&#123;context-&gt;<span class="built_in">enqueueV3</span>(stream)&#125;;</span><br><span class="line">        <span class="keyword">if</span> (!status)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;Failed to run inference.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Synchronize.</span></span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaStreamSynchronize</span>(stream));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copy output data from device to host.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; output_tensor_host_buffers.<span class="built_in">size</span>(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">size_t</span> <span class="type">const</span> tensor_size_bytes&#123;output_tensor_sizes.<span class="built_in">at</span>(i) *</span><br><span class="line">                                       expected_dtype_byte_size&#125;;</span><br><span class="line">        <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaMemcpy</span>(output_tensor_host_buffers.<span class="built_in">at</span>(i),</span><br><span class="line">                                    output_tensor_device_buffers.<span class="built_in">at</span>(i),</span><br><span class="line">                                    tensor_size_bytes, cudaMemcpyDeviceToHost));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Verify the output given it&#x27;s an identity neural network.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; input_tensor_host_buffers.<span class="built_in">size</span>(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (input_tensor_sizes.<span class="built_in">at</span>(i) != output_tensor_sizes.<span class="built_in">at</span>(i))</span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;Input and output tensor sizes do not match.&quot;</span></span><br><span class="line">                      &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">all_close</span>(<span class="built_in">static_cast</span>&lt;<span class="type">float</span>*&gt;(input_tensor_host_buffers.<span class="built_in">at</span>(i)),</span><br><span class="line">                       <span class="built_in">static_cast</span>&lt;<span class="type">float</span>*&gt;(output_tensor_host_buffers.<span class="built_in">at</span>(i)),</span><br><span class="line">                       input_tensor_sizes.<span class="built_in">at</span>(i), rtol, atol))</span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;Input and output tensor values do not match.&quot;</span></span><br><span class="line">                      &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Successfully verified the output.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Release resources.</span></span><br><span class="line">    <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaStreamDestroy</span>(stream));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; input_tensor_host_buffers.<span class="built_in">size</span>(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaFreeHost</span>(input_tensor_host_buffers.<span class="built_in">at</span>(i)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; input_tensor_device_buffers.<span class="built_in">size</span>(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaFree</span>(input_tensor_device_buffers.<span class="built_in">at</span>(i)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; output_tensor_host_buffers.<span class="built_in">size</span>(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaFreeHost</span>(output_tensor_host_buffers.<span class="built_in">at</span>(i)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i&#123;<span class="number">0U</span>&#125;; i &lt; output_tensor_device_buffers.<span class="built_in">size</span>(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">CHECK_CUDA_ERROR</span>(<span class="built_in">cudaFree</span>(output_tensor_device_buffers.<span class="built_in">at</span>(i)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Because the output tensor values matches the input tensor values, we have successfully verified the implementation and integration of the custom plugin.</p>
<h2 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h2><p>The source code of the example can be found in my GitHub repository <a target="_blank" rel="noopener" href="https://github.com/levanliu/TensorRT-Custom-Plugin-Example">“TensorRT Custom Plugin Example”</a>.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.nvidia.com/deeplearning/tensorrt/developer-guide/index.html">TensorRT Developer Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/NVIDIA/TensorRT">TensorRT OSS - GitHub</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>TensorRT Custom Plugin Example</p><p><a href="https://levanliu.github.io/blog/TensorRT-Custom-Plugin-Example/">https://levanliu.github.io/blog/TensorRT-Custom-Plugin-Example/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Lei Mao</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>01-27-2024</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>01-27-2024</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <div><a class="link-muted" rel="tag" href="/tags/CPP/">CPP,</a> </div><div><a class="link-muted" rel="tag" href="/tags/CUDA/">CUDA,</a> </div><div><a class="link-muted" rel="tag" href="/tags/NVIDIA/">NVIDIA,</a> </div><div><a class="link-muted" rel="tag" href="/tags/TensorRT/">TensorRT </a> </div></div></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=61b5930d440224001908310c&amp;product=inline-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered has-text-weight-normal">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" data-type="paypal" onclick="document.getElementById(&#039;paypal-donate-form&#039;).submit()"><span class="icon is-small"><i class="fab fa-paypal"></i></span><span>Paypal</span></a><form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank" rel="noopener" id="paypal-donate-form"><input type="hidden" name="cmd" value="_donations"><input type="hidden" name="business" value="SSVSLEH4X85LU"><input type="hidden" name="currency_code" value="USD"></form><a class="button donate" href="https://www.buymeacoffee.com/levanliu" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>Buy me a coffee</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/life/Richmond-Marina-Bay/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Richmond Marina Bay 徒步</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/essay/2024%E5%B9%B4%E7%BF%94%E5%93%A5%E7%82%92%E8%82%A1%E4%B9%B0%E6%88%BF/"><span class="level-item">2024 年翔哥炒股买房</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card" id="comment-card"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="comment-block"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://levanliu.github.io/blog/TensorRT-Custom-Plugin-Example/';
            this.page.identifier = '/blog/TensorRT-Custom-Plugin-Example/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'levanliu-github-io' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/author_images/Lei-Bio-Medium.jpg" alt="Lei Mao"></figure><p class="title is-size-4 is-block" style="line-height:inherit;margin-bottom:0.30rem;">Lei Mao</p><p class="is-block" style="white-space: pre-line; font-style: italic; margin-bottom: 0.50rem; font-size: 0.8em">Artificial Intelligence
Machine Learning
Computer Science
</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Santa Clara, California</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">733</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">453</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/levanliu" target="_blank" rel="noopener"><i class="fab fa-github"></i>  Follow</a> <a class="level-item button is-primary is-rounded" href="https://github.com/sponsors/levanliu" target="_blank" rel="noopener"><i class="fas fa-heart"></i>  Sponsor</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/levanliu"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/matchalevanliu"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/lei-mao/"><i class="fab fa-linkedin"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:dukelevanliu@gmail.com"><i class="fas fa-envelope-square"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="G.Scholar" href="https://scholar.google.com/citations?user=R2VUf7YAAAAJ"><i class="ai ai-google-scholar-square"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Introduction"><span class="level-left"><span class="level-item">1</span><span class="level-item">Introduction</span></span></a></li><li><a class="level is-mobile" href="#Identity-ONNX-Model"><span class="level-left"><span class="level-item">2</span><span class="level-item">Identity ONNX Model</span></span></a></li><li><a class="level is-mobile" href="#IdentityConv-Custom-Plugin-Implementation"><span class="level-left"><span class="level-item">3</span><span class="level-item">IdentityConv Custom Plugin Implementation</span></span></a></li><li><a class="level is-mobile" href="#IdentityConv-Custom-Plugin-Creator-Implementation"><span class="level-left"><span class="level-item">4</span><span class="level-item">IdentityConv Custom Plugin Creator Implementation</span></span></a></li><li><a class="level is-mobile" href="#Expose-IdentityConv-Custom-Plugin-Creator-to-TensorRT"><span class="level-left"><span class="level-item">5</span><span class="level-item">Expose IdentityConv Custom Plugin Creator to TensorRT</span></span></a></li><li><a class="level is-mobile" href="#Build-Engine-With-Custom-Plugin"><span class="level-left"><span class="level-item">6</span><span class="level-item">Build Engine With Custom Plugin</span></span></a></li><li><a class="level is-mobile" href="#Run-Engine-With-Custom-Plugin"><span class="level-left"><span class="level-item">7</span><span class="level-item">Run Engine With Custom Plugin</span></span></a></li><li><a class="level is-mobile" href="#Source-Code"><span class="level-left"><span class="level-item">8</span><span class="level-item">Source Code</span></span></a></li><li><a class="level is-mobile" href="#References"><span class="level-left"><span class="level-item">9</span><span class="level-item">References</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget"><div class="g-ads-x"><div class="card-content"><div class="menu"><h3 class="menu-label">Advertisement</h3></div><br><center><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CWYDCK3L&amp;placement=levanliugithubio" id="_carbonads_js"></script></center></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/favicon/android-chrome-512x512.png" alt="Lei Mao&#039;s Log Book" height="28"></a><p class="is-size-7"><span>&copy; 2017-2024 Lei Mao</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Site UV: <span id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></span></span> <span id="busuanzi_container_site_pv">Site PV: <span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></span></span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="GitHub" href="https://github.com/levanliu"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script src="/js/night.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>