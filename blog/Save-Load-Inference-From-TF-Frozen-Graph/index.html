<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="twitter:image:src" content="https://leimao.github.io/images/favicon/android-chrome-512x512.png"><meta name="referrer" content="no-referrer-when-downgrade"><title>Save, Load and Inference From TensorFlow Frozen Graph - Lei Mao&#039;s Log Book</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="Lei Mao&#039;s Log Book"><meta name="msapplication-TileImage" content="/images/favicon/android-chrome-192x192.png"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Lei Mao&#039;s Log Book"><meta name="apple-mobile-web-app-status-bar-style" content="default"><link rel="apple-touch-icon" sizes="192x192" href="/images/favicon/android-chrome-192x192.png"><link rel="apple-touch-icon" sizes="512x512" href="/images/favicon/android-chrome-512x512.png"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="16x16" href="/images/favicon/favicon-16x16.png"><link rel="apple-touch-icon" sizes="32x32" href="/images/favicon/favicon-32x32.png"><meta name="description" content="Filling a Missing Part in TensorFlow Inference"><meta property="og:type" content="blog"><meta property="og:title" content="Save, Load and Inference From TensorFlow Frozen Graph"><meta property="og:url" content="https://leimao.github.io/blog/Save-Load-Inference-From-TF-Frozen-Graph/"><meta property="og:site_name" content="Lei Mao&#039;s Log Book"><meta property="og:description" content="Filling a Missing Part in TensorFlow Inference"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://leimao.github.io/images/favicon/android-chrome-512x512.png"><meta property="article:published_time" content="2019-03-07T08:00:00.000Z"><meta property="article:modified_time" content="2020-08-03T07:00:00.000Z"><meta property="article:author" content="Lei Mao"><meta property="article:tag" content="TensorFlow"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://leimao.github.io/images/favicon/android-chrome-512x512.png"><meta property="twitter:creator" content="@matchaleimao"><meta property="twitter:site" content="Lei Mao&#039;s Log Book"><meta property="fb:admins" content="dukeleimao"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://leimao.github.io/blog/Save-Load-Inference-From-TF-Frozen-Graph/"},"headline":"Save, Load and Inference From TensorFlow Frozen Graph","image":["https://leimao.github.io/images/favicon/android-chrome-512x512.png"],"datePublished":"2019-03-07T08:00:00.000Z","dateModified":"2020-08-03T07:00:00.000Z","author":{"@type":"Person","name":"Lei Mao"},"publisher":{"@type":"Organization","name":"Lei Mao's Log Book","logo":{"@type":"ImageObject","url":"https://leimao.github.io/images/favicon/android-chrome-512x512.png"}},"description":"Filling a Missing Part in TensorFlow Inference"}</script><link rel="canonical" href="https://leimao.github.io/blog/Save-Load-Inference-From-TF-Frozen-Graph/"><link rel="alternate" href="/atom.xml" title="Lei Mao&#039;s Log Book" type="application/atom+xml"><link rel="icon" href="/images/favicon/favicon.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons/css/academicons.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=PT+Sans+Narrow:wght@400;700&amp;family=PT+Serif"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-EJY6FXZBCB" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-EJY6FXZBCB');</script><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><script src="//m.servedby-buysellads.com/monetization.custom.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/favicon/android-chrome-512x512.png" alt="Lei Mao&#039;s Log Book" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Lei Mao&#039;s Log Book</a><a class="navbar-item" href="/curriculum">Curriculum</a><a class="navbar-item" href="/blog">Blog</a><a class="navbar-item" href="/article">Articles</a><a class="navbar-item" href="/project">Projects</a><a class="navbar-item" href="/publication">Publications</a><a class="navbar-item" href="/reading">Readings</a><a class="navbar-item" href="/life">Life</a><a class="navbar-item" href="/essay">Essay</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/faq">FAQs</a></div><div class="navbar-end"><a class="navbar-item night" id="night-nav" title="Switch Color Scheme" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/leimao"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Gitter" href="https://gitter.im/leimao/community"><i class="fab fa-gitter"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><div class="card-content"><center><div class="bsa-standard" id="carbon-ad-01"></div><script>            (function() {             if (typeof _bsa !== 'undefined' && _bsa) {                 _bsa.init('custom', 'CWYD65QY', 'placement:leimaogithubio-standard', {                     target: '#carbon-ad-01',                     template: `             <a href='##link##' class='native-banner' style='background: ##backgroundColor##' rel='sponsored noopener' target='_blank' title='##company## — ##tagline##'>                 <img class='native-img' width='125' src='##logo##' />                 <div class='native-main'>                     <div class='native-details' style='                             color: ##textColor##;                             border-left: solid 1px ##textColor##;                         '>                         <span class='native-company'>Sponsored by ##company##</span>                         <span class='native-desc'>##description##</span>                     </div>                     <span class='native-cta' style='                             color: ##ctaTextColor##;                             background-color: ##ctaBackgroundColor##;                         '>##callToAction##</span>                 </div>             </a>             `,                 });                 }             })();         </script></center></div></div><div class="card"><article class="card-content article" role="article"><h1 class="title is-size-3" style="font-family: 'PT Sans Narrow', sans-serif">Save, Load and Inference From TensorFlow Frozen Graph</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left" style="margin-bottom: 0.50rem"><span class="level-item"><i class="far fa-calendar-alt"> </i><time dateTime="2019-03-07T08:00:00.000Z" title="2019-03-07T08:00:00.000Z">03-07-2019</time></span><span class="level-item is-hidden-mobile"><i class="far fa-calendar-check"> </i><time dateTime="2020-08-03T07:00:00.000Z" title="2020-08-03T07:00:00.000Z">08-03-2020</time></span><span class="level-item"><i class="far fa-folder-open has-text-grey"></i> <a class="link-muted" href="/blog/">blog</a></span><span class="level-item"><i class="far fa-clock"></i> 14 minutes read (About 2065 words)</span><span class="level-item" id="busuanzi_container_page_pv"><i class="far fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>&nbsp;visits</span></div></div><div class="content" style="margin-top: 1.0rem"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>TensorFlow model saving has become easier than it was in the early days. Now you can either use <code>Keras</code> to save <code>h5</code> format model or use <code>tf.train.Saver</code> to save the check point files. Loading those saved models are also easy. You can find a lot of instructions on TensorFlow official <a target="_blank" rel="noopener" href="https://www.tensorflow.org/guide/saved_model">tutorials</a>. There is another model format called <code>pb</code> which is frequently seen in model zoos but hardly mentioned by TensorFlow official channels. <code>pb</code> stands for <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a>, it is a language-neutral, platform-neutral extensible mechanism for serializing structured data. It is widely used in model deployment, such as fast inference tool <a target="_blank" rel="noopener" href="https://developer.nvidia.com/tensorrt">TensorRT</a>. While <code>pb</code> format models seem to be important, there is lack of systematic tutorials on how to save, load and do inference on <code>pb</code> format models in TensorFlow. </p>
<p>In this blog post, I am going to introduce how to save, load, and run inference for frozen graph in TensorFlow 1.x. For doing the equivalent tasks in TensorFlow 2.x, please read the other blog post <a href="/blog/Save-Load-Inference-From-TF2-Frozen-Graph/">“Save, Load and Inference From TensorFlow 2.x Frozen Graph”</a>.</p>
<h2 id="Materials"><a href="#Materials" class="headerlink" title="Materials"></a>Materials</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/leimao/Frozen-Graph-TensorFlow/tree/master/TensorFlow_v1">Frozen Graph TensorFlow</a></li>
</ul>
<p>This sample code was available on my GitHub. It was modified from my previous <a target="_blank" rel="noopener" href="https://github.com/leimao/Convolutional_Neural_Network_CIFAR10">simple CNN model</a> to classify CIFAR10 dataset. </p>
<h2 id="Train-Model"><a href="#Train-Model" class="headerlink" title="Train Model"></a>Train Model</h2><p>We have to train our model first. Train the model using the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python main.py --train --<span class="built_in">test</span> --epoch 30 --lr_decay 0.9 --dropout 0.5</span><br></pre></td></tr></table></figure>

<p>The test accuracy after training is around 0.793900.</p>
<h2 id="Save-PB-Model"><a href="#Save-PB-Model" class="headerlink" title="Save PB Model"></a>Save PB Model</h2><p>The major component of <code>pb</code> file is graph structure and also the parameters of your model. While the parameters are optional for <code>pb</code> file, you need it for our task since we need to use parameters to do inference. Otherwise, people download your <code>pb</code> file and they will not be able to deploy it.</p>
<p>This is the key code to save <code>pb</code> file:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tensorflow.python.tools <span class="keyword">import</span> freeze_graph</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self, directory, filename</span>):</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(directory):</span><br><span class="line">            os.makedirs(directory)</span><br><span class="line">        filepath = os.path.join(directory, filename + <span class="string">&#x27;.ckpt&#x27;</span>)</span><br><span class="line">        self.saver.save(self.sess, filepath)</span><br><span class="line">        <span class="keyword">return</span> filepath</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_as_pb</span>(<span class="params">self, directory, filename</span>):</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(directory):</span><br><span class="line">            os.makedirs(directory)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Save check point for graph frozen later</span></span><br><span class="line">        ckpt_filepath = self.save(directory=directory, filename=filename)</span><br><span class="line">        pbtxt_filename = filename + <span class="string">&#x27;.pbtxt&#x27;</span></span><br><span class="line">        pbtxt_filepath = os.path.join(directory, pbtxt_filename)</span><br><span class="line">        pb_filepath = os.path.join(directory, filename + <span class="string">&#x27;.pb&#x27;</span>)</span><br><span class="line">        <span class="comment"># This will only save the graph but the variables will not be saved.</span></span><br><span class="line">        <span class="comment"># You have to freeze your model first.</span></span><br><span class="line">        tf.train.write_graph(graph_or_graph_def=self.sess.graph_def, logdir=directory, name=pbtxt_filename, as_text=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Freeze graph</span></span><br><span class="line">        <span class="comment"># Method 1</span></span><br><span class="line">        freeze_graph.freeze_graph(input_graph=pbtxt_filepath, input_saver=<span class="string">&#x27;&#x27;</span>, input_binary=<span class="literal">False</span>, input_checkpoint=ckpt_filepath, output_node_names=<span class="string">&#x27;cnn/output&#x27;</span>, restore_op_name=<span class="string">&#x27;save/restore_all&#x27;</span>, filename_tensor_name=<span class="string">&#x27;save/Const:0&#x27;</span>, output_graph=pb_filepath, clear_devices=<span class="literal">True</span>, initializer_nodes=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Method 2</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        graph = tf.get_default_graph()</span></span><br><span class="line"><span class="string">        input_graph_def = graph.as_graph_def()</span></span><br><span class="line"><span class="string">        output_node_names = [&#x27;cnn/output&#x27;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        output_graph_def = graph_util.convert_variables_to_constants(self.sess, input_graph_def, output_node_names)</span></span><br><span class="line"><span class="string">        # For some models, we would like to remove training nodes</span></span><br><span class="line"><span class="string">        # output_graph_def = graph_util.remove_training_nodes(output_graph_def, protected_nodes=None)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        with tf.gfile.GFile(pb_filepath, &#x27;wb&#x27;) as f:</span></span><br><span class="line"><span class="string">            f.write(output_graph_def.SerializeToString())</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> pb_filepath</span><br></pre></td></tr></table></figure>

<p>You are required to save checkpoint of your model first, followed by saving the graph. Saving checkpoint is easy, you just have to use <code>tf.train.Saver</code> and everything should be straightforward. In my code, I wrapped saving checkpoint using <code>tf.train.Saver</code> in <code>self.save</code> method. Saving graph is to use <code>tf.train.write_graph</code>. There are two arguments which might be confusing to the new users, <code>name</code> and <code>as_text</code>. <code>as_text</code> is a boolean value indicating whether the saved graph is human-readable or not. By convention, if it is human-readable, the file extension we use will be <code>.pbtxt</code>, else the file extension will be <code>.pb</code>. But this <code>pb</code> file will not contain the parameters you trained in your model. </p>
<p>We then need to freeze and combine graph and parameters to <code>pb</code> file. There are two ways to freeze graph. </p>
<p>The first method is to use <code>freeze_graph</code> function. The argument description of <code>freeze_graph</code> could be found <a target="_blank" rel="noopener" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/tools/freeze_graph.py#L288">here</a>. If <code>input_graph</code> is human-readable <code>pbtxt</code> file, <code>input_binary</code>should be <code>False</code>. If <code>input_graph</code> is binary <code>pb</code> file, <code>input_binary</code>should be <code>True</code>. You will also need to specify the name of your output node. It can be a string if you only have one output, or a list of strings if you have multiple outputs. <code>restore_op_name</code> and <code>filename_tensor_name</code> are being deprecated, using the values provided should be universal to all models. Leave the rest of the arguments the same as mine should be fine. The <code>pb</code> file will be saved to <code>output_graph</code> path you provided.</p>
<p>The second method is to serialization yourself. I believe the first method is just a higher-level wrapper for the second method. The <code>pb</code> files generated from the two methods both pass the accuracy tests that I am going to show below.</p>
<p>The model files generated in the <code>model</code> directory are the follows:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── checkpoint</span><br><span class="line">├── cifar10_cnn.ckpt.data-00000-of-00001</span><br><span class="line">├── cifar10_cnn.ckpt.index</span><br><span class="line">├── cifar10_cnn.ckpt.meta</span><br><span class="line">├── cifar10_cnn.pb</span><br><span class="line">└── cifar10_cnn.pbtxt</span><br></pre></td></tr></table></figure>

<p><code>pb</code> file is there!</p>
<h2 id="Load-PB-Model"><a href="#Load-PB-Model" class="headerlink" title="Load PB Model"></a>Load PB Model</h2><p>We wrote a object to load model from <code>pb</code> files. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CNN</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model_filepath</span>):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># The file path of model</span></span><br><span class="line">        self.model_filepath = model_filepath</span><br><span class="line">        <span class="comment"># Initialize the model</span></span><br><span class="line">        self.load_graph(model_filepath = self.model_filepath)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_graph</span>(<span class="params">self, model_filepath</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Lode trained model.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Loading model...&#x27;</span>)</span><br><span class="line">        self.graph = tf.Graph()</span><br><span class="line">        self.sess = tf.InteractiveSession(graph = self.graph)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> tf.gfile.GFile(model_filepath, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            graph_def = tf.GraphDef()</span><br><span class="line">            graph_def.ParseFromString(f.read())</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Check out the input placeholders:&#x27;</span>)</span><br><span class="line">        nodes = [n.name + <span class="string">&#x27; =&gt; &#x27;</span> +  n.op <span class="keyword">for</span> n <span class="keyword">in</span> graph_def.node <span class="keyword">if</span> n.op <span class="keyword">in</span> (<span class="string">&#x27;Placeholder&#x27;</span>)]</span><br><span class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> nodes:</span><br><span class="line">            <span class="built_in">print</span>(node)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Define input tensor</span></span><br><span class="line">        self.<span class="built_in">input</span> = tf.placeholder(np.float32, shape = [<span class="literal">None</span>, <span class="number">32</span>, <span class="number">32</span>, <span class="number">3</span>], name=<span class="string">&#x27;input&#x27;</span>)</span><br><span class="line">        self.dropout_rate = tf.placeholder(tf.float32, shape = [], name = <span class="string">&#x27;dropout_rate&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        tf.import_graph_def(graph_def, &#123;<span class="string">&#x27;input&#x27;</span>: self.<span class="built_in">input</span>, <span class="string">&#x27;dropout_rate&#x27;</span>: self.dropout_rate&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Model loading complete!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        # Get layer names</span></span><br><span class="line"><span class="string">        layers = [op.name for op in self.graph.get_operations()]</span></span><br><span class="line"><span class="string">        for layer in layers:</span></span><br><span class="line"><span class="string">            print(layer)</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        # Check out the weights of the nodes</span></span><br><span class="line"><span class="string">        weight_nodes = [n for n in graph_def.node if n.op == &#x27;Const&#x27;]</span></span><br><span class="line"><span class="string">        for n in weight_nodes:</span></span><br><span class="line"><span class="string">            print(&quot;Name of the node - %s&quot; % n.name)</span></span><br><span class="line"><span class="string">            print(&quot;Value - &quot; )</span></span><br><span class="line"><span class="string">            print(tensor_util.MakeNdarray(n.attr[&#x27;value&#x27;].tensor))</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">self, data</span>):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Know your output node name</span></span><br><span class="line">        output_tensor = self.graph.get_tensor_by_name(<span class="string">&quot;import/cnn/output:0&quot;</span>)</span><br><span class="line">        output = self.sess.run(output_tensor, feed_dict = &#123;self.<span class="built_in">input</span>: data, self.dropout_rate: <span class="number">0</span>&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure>


<p>Working with the models loaded from <code>pb</code> files is a little bit painful since you will have to work with tensor names all the time. If you are not sure about the tensor names you are working with, try to print out the names from <code>graph_def.node</code>. In our case, because we are going to do inference, we need to bind the inputs of the graph to some placeholder so that we can feed values into the model. Getting the values of parameters is also available via <code>graph_def.node</code>. Here I attached two placeholder to the graph using <code>tf.import_graph_def(graph_def, &#123;&#39;input&#39;: self.input, &#39;dropout_rate&#39;: self.dropout_rate&#125;)</code>. It should be noted that <code>&#39;input&#39;</code> and <code>&#39;dropout_rate&#39;</code> are the name of inputs in the graph I defined in the original graph.</p>
<p>We also set up the <code>test</code> method. Simply find out the tensor you are interested in, in our case it is the output tensor, and feed the input values using <code>sess.run</code>.</p>
<h2 id="Inference-from-PB-Model"><a href="#Inference-from-PB-Model" class="headerlink" title="Inference from PB Model"></a>Inference from PB Model</h2><p>To verify that our loaded graph is correct and working, we need to do some inference to test.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test_from_frozen_graph</span>(<span class="params">model_filepath</span>):</span><br><span class="line"></span><br><span class="line">    tf.reset_default_graph()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Load CIFAR10 dataset</span></span><br><span class="line">    cifar10 = CIFAR10()</span><br><span class="line">    x_test = cifar10.x_test</span><br><span class="line">    y_test = cifar10.y_test</span><br><span class="line">    y_test_onehot = cifar10.y_test_onehot</span><br><span class="line">    num_classes = cifar10.num_classes</span><br><span class="line">    input_size = cifar10.input_size</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Test 500 samples</span></span><br><span class="line">    x_test = x_test[<span class="number">0</span>:<span class="number">500</span>]</span><br><span class="line">    y_test = y_test[<span class="number">0</span>:<span class="number">500</span>]</span><br><span class="line"></span><br><span class="line">    model = CNN(model_filepath = model_filepath)</span><br><span class="line"></span><br><span class="line">    test_prediction_onehot = model.test(data = x_test)</span><br><span class="line">    test_prediction = np.argmax(test_prediction_onehot, axis = <span class="number">1</span>).reshape((-<span class="number">1</span>,<span class="number">1</span>))</span><br><span class="line">    test_accuracy = model_accuracy(label = y_test, prediction = test_prediction)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Test Accuracy: %f&#x27;</span> % test_accuracy)</span><br></pre></td></tr></table></figure>

<p>Run the following command to test:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python test_pb.py</span><br></pre></td></tr></table></figure>

<p>Here I tested 500 samples from the test set. If you want to test all the examples, you can write a for loop to do so. The test accuracy is 0.788000. Comparing to the test accuracy 0.793900 we got right after training, it suggests that the <code>pb</code> file we saved is valid.</p>
<h2 id="Updates"><a href="#Updates" class="headerlink" title="Updates"></a>Updates</h2><h3 id="2019-9-16"><a href="#2019-9-16" class="headerlink" title="2019/9/16"></a>2019/9/16</h3><p>Thanks to the <a target="_blank" rel="noopener" href="http://disq.us/p/24cy6r9">question</a> raised by Yuqiong Li. I removed the usage of <code>tf.InteractiveSession</code> and replaced it with <code>tf.Session</code>. The new object to load <code>pb</code> file is as follows.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CNN</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model_filepath</span>):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># The file path of model</span></span><br><span class="line">        self.model_filepath = model_filepath</span><br><span class="line">        <span class="comment"># Initialize the model</span></span><br><span class="line">        self.load_graph(model_filepath = self.model_filepath)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_graph</span>(<span class="params">self, model_filepath</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Lode trained model.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Loading model...&#x27;</span>)</span><br><span class="line">        self.graph = tf.Graph()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> tf.gfile.GFile(model_filepath, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            graph_def = tf.GraphDef()</span><br><span class="line">            graph_def.ParseFromString(f.read())</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Check out the input placeholders:&#x27;</span>)</span><br><span class="line">        nodes = [n.name + <span class="string">&#x27; =&gt; &#x27;</span> +  n.op <span class="keyword">for</span> n <span class="keyword">in</span> graph_def.node <span class="keyword">if</span> n.op <span class="keyword">in</span> (<span class="string">&#x27;Placeholder&#x27;</span>)]</span><br><span class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> nodes:</span><br><span class="line">            <span class="built_in">print</span>(node)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> self.graph.as_default():</span><br><span class="line">        	<span class="comment"># Define input tensor</span></span><br><span class="line">        	self.<span class="built_in">input</span> = tf.placeholder(np.float32, shape = [<span class="literal">None</span>, <span class="number">32</span>, <span class="number">32</span>, <span class="number">3</span>], name=<span class="string">&#x27;input&#x27;</span>)</span><br><span class="line">        	self.dropout_rate = tf.placeholder(tf.float32, shape = [], name = <span class="string">&#x27;dropout_rate&#x27;</span>)</span><br><span class="line">        	tf.import_graph_def(graph_def, &#123;<span class="string">&#x27;input&#x27;</span>: self.<span class="built_in">input</span>, <span class="string">&#x27;dropout_rate&#x27;</span>: self.dropout_rate&#125;)</span><br><span class="line"></span><br><span class="line">        self.graph.finalize()</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Model loading complete!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Get layer names</span></span><br><span class="line">        layers = [op.name <span class="keyword">for</span> op <span class="keyword">in</span> self.graph.get_operations()]</span><br><span class="line">        <span class="keyword">for</span> layer <span class="keyword">in</span> layers:</span><br><span class="line">            <span class="built_in">print</span>(layer)</span><br><span class="line">        </span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        # Check out the weights of the nodes</span></span><br><span class="line"><span class="string">        weight_nodes = [n for n in graph_def.node if n.op == &#x27;Const&#x27;]</span></span><br><span class="line"><span class="string">        for n in weight_nodes:</span></span><br><span class="line"><span class="string">            print(&quot;Name of the node - %s&quot; % n.name)</span></span><br><span class="line"><span class="string">            # print(&quot;Value - &quot; )</span></span><br><span class="line"><span class="string">            # print(tensor_util.MakeNdarray(n.attr[&#x27;value&#x27;].tensor))</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># In this version, tf.InteractiveSession and tf.Session could be used interchangeably. </span></span><br><span class="line">        <span class="comment"># self.sess = tf.InteractiveSession(graph = self.graph)</span></span><br><span class="line">        self.sess = tf.Session(graph = self.graph)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">self, data</span>):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Know your output node name</span></span><br><span class="line">        output_tensor = self.graph.get_tensor_by_name(<span class="string">&quot;import/cnn/output:0&quot;</span>)</span><br><span class="line">        output = self.sess.run(output_tensor, feed_dict = &#123;self.<span class="built_in">input</span>: data, self.dropout_rate: <span class="number">0</span>&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure>

<p>The previous one is nothing wrong, but I placed the <code>tf.InteractiveSession</code> before the <code>graphdef</code> was loaded to the default graph, taking advantage of the side effect that <code>tf.InteractiveSession</code> will set its corresponding graph as the default graph globally. Therefore, simply replacing <code>tf.InteractiveSession</code> to <code>tf.Session</code> would not work in the previous implementation. This might cause some confusion from the readers who really wanted to understand what is happening underneath. In this new implementation, I specifically created the default graph using Python resource manager and loaded the <code>graphdef</code> to the default graph. No side effect was used and therefore it should be much easier to understand.</p>
<h3 id="2020-1-9"><a href="#2020-1-9" class="headerlink" title="2020/1/9"></a>2020/1/9</h3><p>This blog and example were designed for TensorFlow 1.x. TensorFlow 2.x also supports the frozen graph. Please check the blog post <a href="/blog/Save-Load-Inference-From-TF2-Frozen-Graph/">“Save, Load and Inference From TensorFlow 2.x Frozen Graph”</a>.</p>
<h2 id="Final-Remarks"><a href="#Final-Remarks" class="headerlink" title="Final Remarks"></a>Final Remarks</h2><p>Now you should be good to go with <code>pb</code> file in our deployment! </p>
<p>One additional caveat is that TensorFlow is starting to deprecating or changing a lot of APIs, including part of <code>freeze_graph</code>. We have to be kept updated on those functions.</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Save, Load and Inference From TensorFlow Frozen Graph</p><p><a href="https://leimao.github.io/blog/Save-Load-Inference-From-TF-Frozen-Graph/">https://leimao.github.io/blog/Save-Load-Inference-From-TF-Frozen-Graph/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Lei Mao</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>03-07-2019</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>08-03-2020</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <div><a class="link-muted" rel="tag" href="/tags/TensorFlow/">TensorFlow </a> </div></div></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=61b5930d440224001908310c&amp;product=inline-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered has-text-weight-normal">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" data-type="paypal" onclick="document.getElementById(&#039;paypal-donate-form&#039;).submit()"><span class="icon is-small"><i class="fab fa-paypal"></i></span><span>Paypal</span></a><form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank" rel="noopener" id="paypal-donate-form"><input type="hidden" name="cmd" value="_donations"><input type="hidden" name="business" value="SSVSLEH4X85LU"><input type="hidden" name="currency_code" value="USD"></form><a class="button donate" href="https://www.buymeacoffee.com/leimao" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>Buy me a coffee</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/blog/Solve-Sublime-Scroll-Lag-Problem/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Solve Text Editor Sublime 3 Scroll Lag Problem</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/blog/Focal-Loss-Explained/"><span class="level-item">Use Focal Loss To Train Model Using Imbalanced Dataset</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card" id="comment-card"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="comment-block"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://leimao.github.io/blog/Save-Load-Inference-From-TF-Frozen-Graph/';
            this.page.identifier = '/blog/Save-Load-Inference-From-TF-Frozen-Graph/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'leimao-github-io' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/author_images/Lei-Bio-Medium.jpg" alt="Lei Mao"></figure><p class="title is-size-4 is-block" style="line-height:inherit;margin-bottom:0.30rem;">Lei Mao</p><p class="is-block" style="white-space: pre-line; font-style: italic; margin-bottom: 0.50rem; font-size: 0.8em">Artificial Intelligence
Machine Learning
Computer Science
</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Santa Clara, California</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">733</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">453</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/leimao" target="_blank" rel="noopener"><i class="fab fa-github"></i>  Follow</a> <a class="level-item button is-primary is-rounded" href="https://github.com/sponsors/leimao" target="_blank" rel="noopener"><i class="fas fa-heart"></i>  Sponsor</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/leimao"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/matchaleimao"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/lei-mao/"><i class="fab fa-linkedin"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:dukeleimao@gmail.com"><i class="fas fa-envelope-square"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="G.Scholar" href="https://scholar.google.com/citations?user=R2VUf7YAAAAJ"><i class="ai ai-google-scholar-square"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Introduction"><span class="level-left"><span class="level-item">1</span><span class="level-item">Introduction</span></span></a></li><li><a class="level is-mobile" href="#Materials"><span class="level-left"><span class="level-item">2</span><span class="level-item">Materials</span></span></a></li><li><a class="level is-mobile" href="#Train-Model"><span class="level-left"><span class="level-item">3</span><span class="level-item">Train Model</span></span></a></li><li><a class="level is-mobile" href="#Save-PB-Model"><span class="level-left"><span class="level-item">4</span><span class="level-item">Save PB Model</span></span></a></li><li><a class="level is-mobile" href="#Load-PB-Model"><span class="level-left"><span class="level-item">5</span><span class="level-item">Load PB Model</span></span></a></li><li><a class="level is-mobile" href="#Inference-from-PB-Model"><span class="level-left"><span class="level-item">6</span><span class="level-item">Inference from PB Model</span></span></a></li><li><a class="level is-mobile" href="#Updates"><span class="level-left"><span class="level-item">7</span><span class="level-item">Updates</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2019-9-16"><span class="level-left"><span class="level-item">7.1</span><span class="level-item">2019/9/16</span></span></a></li><li><a class="level is-mobile" href="#2020-1-9"><span class="level-left"><span class="level-item">7.2</span><span class="level-item">2020/1/9</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Final-Remarks"><span class="level-left"><span class="level-item">8</span><span class="level-item">Final Remarks</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget"><div class="g-ads-x"><div class="card-content"><div class="menu"><h3 class="menu-label">Advertisement</h3></div><br><center><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CWYDCK3L&amp;placement=leimaogithubio" id="_carbonads_js"></script></center></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/favicon/android-chrome-512x512.png" alt="Lei Mao&#039;s Log Book" height="28"></a><p class="is-size-7"><span>&copy; 2017-2024 Lei Mao</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Site UV: <span id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></span></span> <span id="busuanzi_container_site_pv">Site PV: <span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></span></span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="GitHub" href="https://github.com/leimao"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script src="/js/night.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>